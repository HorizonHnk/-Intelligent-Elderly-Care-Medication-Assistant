<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=0.5, maximum-scale=3.0">
    <title>Intelligent Elderly Care & Medication Assistant</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4f46e5">
    <meta name="description" content="AI-powered medication management system for elderly care">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        :root {
            --primary: #4f46e5;
            --primary-dark: #3730a3;
            --success: #10b981;
            --success-dark: #059669;
            --danger: #ef4444;
            --danger-dark: #dc2626;
            --warning: #f59e0b;
            --white: #ffffff;
            --gray-50: #fafafa;
            --gray-100: #f5f5f5;
            --gray-200: #eeeeee;
            --gray-300: #e0e0e0;
            --gray-400: #bdbdbd;
            --gray-500: #9e9e9e;
            --gray-600: #757575;
            --gray-700: #616161;
            --gray-800: #424242;
            --gray-900: #212121;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.06);
            --shadow: 0 2px 6px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 10px rgba(0,0,0,0.1);
            --shadow-lg: 0 6px 20px rgba(0,0,0,0.12);
            --radius-sm: clamp(6px, 1.5vw, 10px);
            --radius: clamp(10px, 2vw, 14px);
            --radius-lg: clamp(12px, 2.5vw, 18px);
        }

        /* Responsive base font size */
        html {
            font-size: clamp(14px, 2.5vw, 16px);
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--white);
            color: var(--gray-900);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            font-weight: 400;
            letter-spacing: -0.01em;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            padding-top: clamp(70px, 15vw, 100px);
        }

        /* Header Navigation */
        .header {
            background: #ffffff;
            padding: clamp(12px, 2.5vw, 20px) clamp(16px, 3vw, 30px);
            box-shadow: var(--shadow);
            border-bottom: 1px solid var(--gray-300);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            transition: transform 0.3s ease-in-out;
        }

        .header.hidden {
            transform: translateY(-100%);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: clamp(12px, 2vw, 16px);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: clamp(18px, 4vw, 24px);
            font-weight: 700;
            color: var(--primary);
        }

        .nav-menu {
            display: flex;
            gap: clamp(8px, 1.5vw, 12px);
            align-items: center;
            flex-wrap: wrap;
        }

        .nav-btn, .emergency-btn, .settings-btn {
            background: var(--primary);
            border: none;
            color: white;
            padding: clamp(10px, 2vw, 14px) clamp(16px, 3vw, 20px);
            border-radius: var(--radius);
            cursor: pointer;
            font-size: clamp(13px, 2.5vw, 15px);
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            box-shadow: var(--shadow-sm);
            font-family: inherit;
        }

        .emergency-btn {
            background: var(--danger);
            animation: pulse-emergency 2s infinite;
        }

        @keyframes pulse-emergency {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            50% { transform: scale(1.03); box-shadow: 0 0 0 8px rgba(239, 68, 68, 0); }
        }

        .settings-btn { background: var(--gray-600); }
        .nav-btn:hover { background: var(--primary-dark); transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .emergency-btn:hover { background: var(--danger-dark); }
        .settings-btn:hover { background: var(--gray-700); }

        /* Main Container */
        .main-container {
            flex: 1;
            padding: clamp(16px, 3.5vw, 32px);
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
            transition: padding 0.3s ease;
        }

        /* Dashboard Stats Bar */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(clamp(140px, 35vw, 200px), 1fr));
            gap: clamp(12px, 2.5vw, 16px);
            margin-bottom: clamp(20px, 4vw, 32px);
        }

        .stat-card {
            background: #ffffff;
            padding: clamp(16px, 3.5vw, 20px);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--gray-300);
            transition: all 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .stat-label {
            font-size: clamp(12px, 2.2vw, 13px);
            color: var(--gray-500);
            margin-bottom: 8px;
            font-weight: 500;
        }

        .stat-value {
            font-size: clamp(24px, 5.5vw, 32px);
            font-weight: 700;
            color: var(--primary);
        }

        .stat-change {
            font-size: clamp(11px, 2vw, 12px);
            color: var(--success);
            margin-top: 4px;
        }

        /* Tab Navigation */
        .tab-navigation {
            display: flex;
            flex-wrap: wrap;
            gap: clamp(8px, 1.5vw, 12px);
            margin-bottom: clamp(20px, 4vw, 28px);
            overflow-x: visible;
            padding-bottom: 8px;
        }

        .tab-btn {
            background: #ffffff;
            border: 2px solid var(--gray-300);
            color: var(--gray-700);
            padding: clamp(10px, 2vw, 14px) clamp(16px, 3vw, 24px);
            border-radius: var(--radius);
            cursor: pointer;
            font-size: clamp(13px, 2.5vw, 15px);
            font-weight: 500;
            transition: all 0.2s;
            white-space: nowrap;
            font-family: inherit;
        }

        .tab-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .tab-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(100%, 320px), 1fr));
            gap: clamp(16px, 3vw, 24px);
            margin-bottom: clamp(20px, 4vw, 32px);
        }

        .card {
            background: #ffffff;
            border-radius: var(--radius-lg);
            padding: clamp(20px, 4vw, 28px);
            box-shadow: var(--shadow);
            border: 1px solid var(--gray-300);
            transition: all 0.2s;
        }

        .card:hover {
            box-shadow: var(--shadow-md);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: clamp(16px, 3vw, 20px);
            padding-bottom: 12px;
            border-bottom: 2px solid var(--gray-200);
        }

        .card-title {
            font-size: clamp(18px, 4vw, 22px);
            font-weight: 600;
            color: var(--gray-900);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-action {
            background: var(--gray-100);
            border: none;
            color: var(--gray-700);
            padding: 8px 14px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: clamp(12px, 2.2vw, 13px);
            font-weight: 500;
            transition: all 0.2s;
            font-family: inherit;
        }

        .card-action:hover {
            background: var(--gray-200);
        }

        /* Medication Item */
        .medication-item {
            background: #ffffff;
            padding: clamp(14px, 3vw, 18px);
            border-radius: var(--radius);
            margin-bottom: clamp(12px, 2vw, 16px);
            border-left: 4px solid var(--primary);
            border: 1px solid var(--gray-300);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: clamp(12px, 2vw, 16px);
            flex-wrap: wrap;
            transition: all 0.2s;
            box-shadow: var(--shadow-sm);
        }

        .medication-item:hover {
            background: var(--gray-50);
            transform: translateX(4px);
            box-shadow: var(--shadow-md);
        }

        .medication-info {
            flex: 1;
            min-width: 200px;
        }

        .medication-name {
            font-weight: 600;
            font-size: clamp(15px, 3vw, 17px);
            color: var(--gray-900);
            margin-bottom: 6px;
        }

        .medication-time {
            font-size: clamp(13px, 2.5vw, 14px);
            color: var(--gray-600);
            margin-bottom: 4px;
        }

        .medication-dosage {
            font-size: clamp(12px, 2.2vw, 13px);
            color: var(--gray-500);
        }

        .medication-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .status-indicator {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 2px solid #ffffff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .status-pending {
            background: var(--warning);
            animation: pulse-status 2s infinite;
        }

        .status-taken {
            background: var(--success);
        }

        .status-missed {
            background: var(--danger);
        }

        @keyframes pulse-status {
            0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7); }
            50% { opacity: 0.8; box-shadow: 0 0 0 6px rgba(245, 158, 11, 0); }
        }

        .confirm-btn {
            background: var(--success);
            border: none;
            color: white;
            padding: clamp(10px, 2vw, 12px) clamp(16px, 3vw, 20px);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: clamp(12px, 2.2vw, 14px);
            font-weight: 500;
            transition: all 0.2s;
            font-family: inherit;
        }

        .confirm-btn:hover {
            background: var(--success-dark);
            transform: scale(1.05);
        }

        .confirm-btn:disabled {
            background: var(--gray-400);
            cursor: not-allowed;
        }

        /* Action Buttons */
        .action-btn-group {
            display: flex;
            gap: clamp(10px, 2vw, 14px);
            flex-wrap: wrap;
            margin-top: 16px;
        }

        .action-btn {
            flex: 1;
            min-width: clamp(120px, 30vw, 160px);
            background: var(--primary);
            border: none;
            color: white;
            padding: clamp(12px, 2.5vw, 16px);
            border-radius: var(--radius);
            cursor: pointer;
            font-size: clamp(13px, 2.5vw, 15px);
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-family: inherit;
        }

        .action-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .action-btn-secondary {
            flex: 1;
            min-width: clamp(120px, 30vw, 160px);
            background: #ffffff;
            color: var(--primary);
            border: 2px solid var(--primary);
            padding: clamp(12px, 2.5vw, 16px);
            border-radius: var(--radius);
            cursor: pointer;
            font-size: clamp(13px, 2.5vw, 15px);
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-family: inherit;
            box-shadow: var(--shadow-sm);
        }

        .action-btn-secondary:hover {
            background: var(--gray-50);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* Modal/Dialog */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: clamp(20px, 4vw, 40px);
            animation: fadeIn 0.2s;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #ffffff;
            padding: clamp(24px, 4vw, 36px);
            border-radius: var(--radius-lg);
            width: min(clamp(320px, 90vw, 600px), 95vw);
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--gray-200);
        }

        .modal-title {
            font-size: clamp(20px, 4.5vw, 24px);
            font-weight: 600;
            color: var(--gray-900);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 28px;
            color: var(--gray-500);
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .close-modal:hover {
            background: var(--gray-200);
            color: var(--gray-900);
        }

        /* Form Elements */
        .form-group {
            margin-bottom: clamp(18px, 3.5vw, 24px);
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: clamp(13px, 2.5vw, 14px);
            font-weight: 500;
            color: var(--gray-700);
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: clamp(12px, 2.5vw, 14px);
            border: 2px solid var(--gray-300);
            border-radius: var(--radius-sm);
            font-size: clamp(14px, 2.8vw, 15px);
            font-family: inherit;
            transition: all 0.2s;
            background: #ffffff;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            background: #ffffff;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Range Input (Slider) Styling */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: var(--gray-300);
            border-radius: 10px;
            outline: none;
            padding: 0;
            margin: 10px 0;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            background: var(--primary-dark);
            transform: scale(1.1);
            box-shadow: var(--shadow-md);
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s;
        }

        input[type="range"]::-moz-range-thumb:hover {
            background: var(--primary-dark);
            transform: scale(1.1);
            box-shadow: var(--shadow-md);
        }

        /* Alert Notification */
        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: clamp(16px, 3vw, 20px) clamp(20px, 4vw, 28px);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 2000;
            max-width: clamp(300px, 85vw, 400px);
            animation: slideInRight 0.3s;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .alert.active {
            display: flex;
        }

        .alert-success {
            background: var(--success);
            color: white;
        }

        .alert-error {
            background: var(--danger);
            color: white;
        }

        .alert-warning {
            background: var(--warning);
            color: white;
        }

        .alert-info {
            background: var(--primary);
            color: white;
        }

        /* Loading Spinner */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 3px solid var(--gray-300);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: clamp(40px, 8vw, 50px);
            height: clamp(40px, 8vw, 50px);
            animation: spin 1s linear infinite;
            margin: 0 auto 12px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: clamp(14px, 2.8vw, 15px);
            color: var(--gray-600);
        }

        /* Video Interface */
        .video-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }

        .video-preview {
            width: 100%;
            height: auto;
            display: block;
            background: var(--gray-900);
        }

        .video-controls {
            display: flex;
            gap: 10px;
            margin-top: 16px;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* Responsive Design - Enhanced for all screen sizes */

        /* Very Small Screens (≤320px) - Older smartphones */
        @media (max-width: 320px) {
            html {
                font-size: 13px;
            }

            body {
                padding-top: 60px;
            }

            .header {
                padding: 10px 12px;
            }

            .logo {
                font-size: 16px;
            }

            .nav-btn, .emergency-btn, .settings-btn {
                padding: 8px 12px;
                font-size: 12px;
            }

            .main-container {
                padding: 12px;
            }

            .stat-card, .card {
                padding: 12px;
            }

            .modal-content {
                padding: 16px;
                width: 95vw;
            }

            .tab-btn {
                padding: 8px 12px;
                font-size: 12px;
            }
        }

        /* Small Screens (321px - 480px) - Modern smartphones portrait */
        @media (min-width: 321px) and (max-width: 480px) {
            body {
                padding-top: 75px;
            }

            .header-content {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }

            .nav-menu {
                justify-content: center;
                flex-wrap: wrap;
                gap: 8px;
            }

            .stats-bar {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .medication-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .medication-actions {
                width: 100%;
                justify-content: space-between;
            }

            .action-btn-group {
                flex-direction: column;
            }

            .action-btn, .action-btn-secondary {
                width: 100%;
                min-width: 100%;
            }

            .video-controls {
                flex-direction: column;
            }

            .video-controls button {
                width: 100%;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Medium Screens (481px - 768px) - Tablets portrait, large phones landscape */
        @media (min-width: 481px) and (max-width: 768px) {
            body {
                padding-top: 85px;
            }

            .stats-bar {
                grid-template-columns: repeat(2, 1fr);
            }

            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Large Screens (769px - 1024px) - Tablets landscape, small laptops */
        @media (min-width: 769px) and (max-width: 1024px) {
            body {
                padding-top: 90px;
            }

            .stats-bar {
                grid-template-columns: repeat(2, 1fr);
            }

            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .main-container {
                padding: 24px;
            }
        }

        /* Very Large Screens (≥1025px) - Desktops, large laptops */
        @media (min-width: 1025px) {
            body {
                padding-top: 100px;
            }

            .stats-bar {
                grid-template-columns: repeat(4, 1fr);
            }

            .dashboard-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .main-container {
                padding: 32px;
                max-width: 1400px;
            }
        }

        /* Extra Large Screens (≥1440px) - Large desktops */
        @media (min-width: 1441px) {
            .main-container {
                max-width: 1600px;
            }

            .dashboard-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* Landscape Orientation Adjustments */
        @media (max-height: 500px) and (orientation: landscape) {
            body {
                padding-top: 60px;
            }

            .header {
                padding: 8px 16px;
            }

            .modal-content {
                max-height: 85vh;
            }
        }

        /* Print Styles */
        @media print {
            .header, .tab-navigation, .action-btn-group, .nav-btn, .modal {
                display: none !important;
            }

            .card {
                page-break-inside: avoid;
            }
        }

        /* High Contrast Mode */
        @media (prefers-contrast: high) {
            .card, .stat-card, .medication-item {
                border-width: 2px;
            }
        }

        /* Link Styling */
        a {
            color: var(--primary);
            text-decoration: none;
            transition: all 0.2s;
        }

        a:hover {
            color: var(--primary-dark);
            text-decoration: underline;
        }

        a:focus {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* Accessibility */
        *:focus-visible {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }

        /* Reduced Motion */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Dark Mode */
        body.dark-mode {
            background: #1a1a1a;
            color: #e0e0e0;
        }

        body.dark-mode .header {
            background: #2d2d2d;
            border-bottom-color: #404040;
        }

        body.dark-mode .card,
        body.dark-mode .stat-card,
        body.dark-mode .medication-item {
            background: #2d2d2d;
            border-color: #404040;
            color: #e0e0e0;
        }

        body.dark-mode .card:hover,
        body.dark-mode .stat-card:hover {
            background: #353535;
        }

        body.dark-mode .medication-item:hover {
            background: #353535;
        }

        body.dark-mode .form-input,
        body.dark-mode .form-select,
        body.dark-mode .form-textarea {
            background: #353535;
            border-color: #404040;
            color: #e0e0e0;
        }

        body.dark-mode .modal-content {
            background: #2d2d2d;
            color: #e0e0e0;
        }

        body.dark-mode .call-content {
            background: #2d2d2d;
        }

        body.dark-mode .video-call-interface {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
        }

        body.dark-mode .call-interface {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
        }

        /* Footer stays light in dark mode for better readability */
        body.dark-mode .footer {
            background: linear-gradient(135deg, #ffffff 0%, var(--gray-100) 100%);
            border-top-color: var(--primary);
        }

        body.dark-mode .footer-bottom {
            border-top-color: var(--gray-300);
        }

        /* Hamburger Menu */
        .hamburger-menu {
            display: none;
            flex-direction: column;
            gap: 5px;
            background: white;
            border: none;
            cursor: pointer;
            padding: 10px;
            border-radius: 8px;
            z-index: 1001;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .hamburger-menu:hover {
            background: var(--gray-100);
            transform: scale(1.05);
        }

        .hamburger-menu span {
            display: block;
            width: 25px;
            height: 3px;
            background: var(--gray-900);
            border-radius: 3px;
            transition: all 0.3s ease;
        }

        .hamburger-menu.active {
            background: var(--gray-100);
        }

        .hamburger-menu.active span {
            background: var(--primary);
        }

        .hamburger-menu.active span:nth-child(1) {
            transform: rotate(45deg) translate(7px, 7px);
        }

        .hamburger-menu.active span:nth-child(2) {
            opacity: 0;
        }

        .hamburger-menu.active span:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -7px);
        }

        .logo-icon {
            font-size: 28px;
        }

        /* Footer Styles - Light Theme */
        .footer {
            background: linear-gradient(135deg, #ffffff 0%, var(--gray-100) 100%);
            color: var(--gray-900);
            margin-top: auto;
            padding: 50px 20px 25px;
            border-top: 3px solid var(--primary);
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.05);
        }

        .footer-content {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 40px;
            margin-bottom: 30px;
        }

        .footer-section {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .footer-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--primary);
            background: linear-gradient(135deg, var(--primary), #7c3aed);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .footer-subtitle {
            font-size: 16px;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 8px;
            border-bottom: 2px solid var(--primary);
            padding-bottom: 8px;
            display: inline-block;
        }

        .footer-text {
            color: var(--gray-600);
            line-height: 1.7;
            font-size: 14px;
        }

        .footer-social {
            display: flex;
            gap: 12px;
            margin-top: 12px;
        }

        .social-link {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 42px;
            height: 42px;
            background: linear-gradient(135deg, var(--primary), #7c3aed);
            border-radius: 50%;
            text-decoration: none;
            font-size: 20px;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(79, 70, 229, 0.3);
        }

        .social-link:hover {
            background: linear-gradient(135deg, #7c3aed, var(--primary));
            transform: translateY(-5px) scale(1.1);
            box-shadow: 0 8px 16px rgba(79, 70, 229, 0.4);
        }

        .footer-links {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .footer-links a {
            color: var(--gray-700);
            text-decoration: none;
            font-size: 14px;
            transition: all 0.3s;
            display: inline-block;
            position: relative;
            padding-left: 0;
        }

        .footer-links a::before {
            content: '→';
            position: absolute;
            left: -20px;
            opacity: 0;
            transition: all 0.3s;
            color: var(--primary);
        }

        .footer-links a:hover {
            color: var(--primary);
            padding-left: 20px;
            font-weight: 500;
        }

        .footer-links a:hover::before {
            opacity: 1;
            left: 0;
        }

        .footer-contact {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .footer-contact li {
            color: var(--gray-700);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .footer-bottom {
            max-width: 1400px;
            margin: 0 auto;
            padding-top: 25px;
            border-top: 2px solid var(--gray-300);
            text-align: center;
            color: var(--gray-600);
            font-size: 13px;
        }

        .footer-bottom p {
            margin: 8px 0;
        }

        .footer-bottom a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s;
        }

        .footer-bottom a:hover {
            color: #7c3aed;
            text-decoration: underline;
        }

        /* Mobile Responsive Menu */
        @media (max-width: 1024px) {
            .hamburger-menu {
                display: flex;
            }

            /* Modern Light Sidebar Menu */
            .nav-menu {
                position: fixed;
                top: 0;
                right: -100%;
                height: 100vh;
                width: 320px;
                background: linear-gradient(180deg, #ffffff 0%, var(--gray-50) 100%);
                flex-direction: column;
                padding: 80px 20px 20px;
                gap: 10px;
                box-shadow: -8px 0 30px rgba(0, 0, 0, 0.15);
                transition: right 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
                z-index: 1000;
                overflow-y: auto;
                border-left: 3px solid var(--primary);
            }

            .nav-menu.active {
                right: 0;
            }

            /* Close button in menu */
            .nav-menu::before {
                content: '✕';
                position: absolute;
                top: 20px;
                right: 20px;
                font-size: 28px;
                color: var(--gray-600);
                cursor: pointer;
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                background: var(--gray-200);
                transition: all 0.3s;
            }

            .nav-menu.active::before:hover {
                background: var(--danger);
                color: white;
                transform: rotate(90deg);
            }

            /* Modern Menu Buttons - Light Theme */
            .nav-menu button {
                width: 100%;
                justify-content: flex-start;
                font-size: 15px;
                padding: 16px 20px;
                background: white;
                color: var(--gray-900);
                border: 2px solid var(--gray-200);
                border-radius: 12px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
                font-weight: 500;
                transition: all 0.3s;
            }

            .nav-menu button:hover {
                background: var(--gray-50);
                border-color: var(--primary);
                color: var(--primary);
                transform: translateX(5px);
                box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2);
            }

            .nav-menu .emergency-btn {
                background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
                color: white;
                border: none;
                font-weight: 600;
                animation: pulse-emergency 2s infinite;
            }

            .nav-menu .emergency-btn:hover {
                background: linear-gradient(135deg, #dc2626 0%, var(--danger) 100%);
                color: white;
            }

            .nav-menu .settings-btn {
                background: linear-gradient(135deg, var(--primary) 0%, #7c3aed 100%);
                color: white;
                border: none;
                font-weight: 600;
                margin-top: 10px;
            }

            .nav-menu .settings-btn:hover {
                background: linear-gradient(135deg, #7c3aed 0%, var(--primary) 100%);
                color: white;
            }

            /* Overlay when menu is open */
            .nav-menu.active ~ .main-container::before {
                content: '';
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
                backdrop-filter: blur(2px);
            }

            .header-content {
                position: relative;
            }

            .logo {
                font-size: 18px;
            }

            .logo-icon {
                font-size: 24px;
            }
        }

        /* Tablet adjustments (769px - 1024px) */
        @media (max-width: 1024px) and (min-width: 769px) {
            .action-btn-group {
                gap: 12px;
            }

            .action-btn, .action-btn-secondary {
                font-size: 14px;
                padding: 14px 18px;
            }

            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Tablet adjustments (641px - 768px) */
        @media (max-width: 768px) {
            .footer-content {
                grid-template-columns: repeat(2, 1fr);
                gap: 30px;
            }

            .stat-card {
                min-height: 100px;
            }

            .main-container {
                padding: 20px 16px;
            }

            .nav-menu {
                width: 280px;
            }

            .action-btn-group {
                gap: 10px;
            }

            .action-btn, .action-btn-secondary {
                font-size: 14px;
                padding: 13px 16px;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .card {
                padding: 16px;
            }

            .card-title {
                font-size: 18px;
            }
        }

        /* Small Mobile adjustments (481px - 640px) */
        @media (max-width: 640px) {
            .footer-content {
                grid-template-columns: 1fr;
                gap: 35px;
            }

            .footer {
                padding: 40px 20px 20px;
            }

            .footer-section {
                gap: 14px;
            }

            .footer-title {
                font-size: 20px;
            }

            .footer-subtitle {
                font-size: 15px;
            }

            .stats-bar {
                grid-template-columns: repeat(2, 1fr);
            }

            .action-btn-group {
                gap: 10px;
            }

            .action-btn, .action-btn-secondary {
                font-size: 13px;
                padding: 12px 14px;
            }

            .card {
                padding: 14px;
            }

            .card-title {
                font-size: 17px;
            }

            /* Make call/video buttons stack on very small screens */
            .action-btn-group > div {
                flex-direction: column !important;
            }

            .action-btn-group > div > button {
                width: 100% !important;
            }
        }

        /* Very small screens (≤480px) */
        @media (max-width: 480px) {
            .logo span:not(.logo-icon) {
                font-size: 14px;
            }

            .logo-icon {
                font-size: 20px;
            }

            .nav-menu {
                width: 85vw;
                max-width: 320px;
            }

            .hamburger-menu {
                padding: 8px;
            }

            .hamburger-menu span {
                width: 22px;
            }

            .footer-bottom {
                font-size: 12px;
            }

            .stats-bar {
                grid-template-columns: 1fr;
            }

            .action-btn-group {
                gap: 8px;
            }

            .action-btn, .action-btn-secondary {
                font-size: 12px;
                padding: 11px 12px;
            }

            .card {
                padding: 12px;
                border-radius: 10px;
            }

            .card-title {
                font-size: 16px;
            }

            .card-header {
                margin-bottom: 12px;
            }

            /* Make call/video buttons stack */
            .action-btn-group > div {
                flex-direction: column !important;
                gap: 8px !important;
            }

            .action-btn-group > div > button {
                width: 100% !important;
            }

            .main-container {
                padding: 16px 12px;
            }

            .header {
                padding: 12px 12px;
            }

            .tab-btn {
                font-size: 12px;
                padding: 10px 12px;
            }
        }

        /* Extra small screens (≤360px) */
        @media (max-width: 360px) {
            .logo span:not(.logo-icon) {
                font-size: 13px;
            }

            .logo-icon {
                font-size: 18px;
            }

            .action-btn, .action-btn-secondary {
                font-size: 11px;
                padding: 10px 10px;
            }

            .card {
                padding: 10px;
            }

            .card-title {
                font-size: 15px;
            }

            .main-container {
                padding: 12px 8px;
            }

            .stat-card {
                padding: 12px;
            }

            .stat-value {
                font-size: 20px;
            }

            .tab-btn {
                font-size: 11px;
                padding: 8px 10px;
            }
        }

        /* Quick Actions Responsive Styles */
        .action-btn-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .action-btn, .action-btn-secondary {
            font-size: clamp(14px, 2.5vw, 16px);
            padding: clamp(12px, 2.5vw, 16px) clamp(16px, 3vw, 24px);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Very large screens */
        @media (min-width: 1920px) {
            .footer-content {
                grid-template-columns: repeat(4, 1fr);
                gap: 60px;
            }

            .main-container {
                padding: 40px;
            }

            .footer {
                padding: 60px 40px 30px;
            }

            .footer-title {
                font-size: 24px;
            }

            .footer-subtitle {
                font-size: 18px;
            }

            .action-btn-group {
                gap: 16px;
            }

            .action-btn, .action-btn-secondary {
                font-size: 16px;
                padding: 16px 24px;
            }

            .dashboard-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* Large screens (1441px - 1919px) */
        @media (min-width: 1441px) and (max-width: 1919px) {
            .action-btn-group {
                gap: 14px;
            }

            .action-btn, .action-btn-secondary {
                font-size: 15px;
                padding: 14px 20px;
            }

            .dashboard-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* Medium-Large screens (1025px - 1440px) */
        @media (min-width: 1025px) and (max-width: 1440px) {
            .action-btn-group {
                gap: 12px;
            }

            .action-btn, .action-btn-secondary {
                font-size: 14px;
                padding: 13px 18px;
            }

            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Hardware Tab Styles - Light Theme */
        .hardware-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(100%, 350px), 1fr));
            gap: clamp(16px, 3vw, 24px);
        }

        .hardware-status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(min(100%, 280px), 1fr));
            gap: clamp(12px, 2vw, 16px);
            margin-top: 16px;
        }

        .hardware-component {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: clamp(12px, 2.5vw, 16px);
            background: white;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius);
            transition: all 0.3s;
        }

        .hardware-component:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.15);
            transform: translateY(-2px);
        }

        .component-icon {
            font-size: clamp(28px, 5vw, 36px);
            flex-shrink: 0;
        }

        .component-info {
            flex: 1;
            min-width: 0;
        }

        .component-name {
            font-size: clamp(14px, 2.5vw, 16px);
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 6px;
        }

        .component-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
            font-size: clamp(13px, 2.2vw, 14px);
            color: var(--gray-700);
        }

        .component-detail {
            font-size: clamp(11px, 2vw, 12px);
            color: var(--gray-500);
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .status-connected {
            background: var(--success);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
            animation: pulse-status 2s infinite;
        }

        .status-disconnected {
            background: var(--danger);
        }

        .status-warning {
            background: var(--warning);
        }

        @keyframes pulse-status {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .led-indicator {
            display: inline-block;
            width: clamp(16px, 3vw, 20px);
            height: clamp(16px, 3vw, 20px);
            border-radius: 50%;
            border: 2px solid var(--gray-300);
            transition: all 0.3s;
        }

        .led-red {
            background: #ef4444;
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.6);
        }

        .led-green {
            background: #10b981;
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.6);
        }

        .led-blue {
            background: #3b82f6;
            box-shadow: 0 0 8px rgba(59, 130, 246, 0.6);
        }

        .led-indicator.off {
            background: var(--gray-300);
            box-shadow: none;
        }

        /* Component Testing */
        .test-quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(100%, 150px), 1fr));
            gap: clamp(10px, 2vw, 12px);
            margin-top: 16px;
        }

        .test-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: clamp(14px, 3vw, 18px) clamp(12px, 2.5vw, 16px);
            background: linear-gradient(135deg, white 0%, var(--gray-50) 100%);
            border: 2px solid var(--gray-200);
            border-radius: var(--radius);
            font-size: clamp(13px, 2.2vw, 14px);
            font-weight: 500;
            color: var(--gray-900);
            cursor: pointer;
            transition: all 0.3s;
        }

        .test-btn:hover {
            background: linear-gradient(135deg, var(--primary) 0%, #7c3aed 100%);
            border-color: var(--primary);
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(79, 70, 229, 0.3);
        }

        .test-icon {
            font-size: clamp(24px, 5vw, 32px);
        }

        .test-label {
            font-size: clamp(12px, 2vw, 13px);
        }

        /* Hardware Diagram */
        .hardware-diagram {
            margin-top: 16px;
            padding: clamp(16px, 3vw, 20px);
            background: var(--gray-50);
            border-radius: var(--radius);
        }

        .diagram-components {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(100%, 250px), 1fr));
            gap: clamp(16px, 3vw, 20px);
        }

        .diagram-section {
            padding: clamp(14px, 3vw, 16px);
            background: white;
            border-radius: var(--radius-sm);
            border-left: 4px solid var(--primary);
        }

        .diagram-section h4 {
            color: var(--primary);
            font-size: clamp(15px, 2.8vw, 17px);
            margin-bottom: 12px;
            font-weight: 600;
        }

        .diagram-section ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .diagram-section li {
            padding: clamp(6px, 1.5vw, 8px) 0;
            font-size: clamp(12px, 2.2vw, 14px);
            color: var(--gray-700);
            padding-left: 20px;
            position: relative;
        }

        .diagram-section li::before {
            content: '▸';
            position: absolute;
            left: 0;
            color: var(--primary);
        }

        /* Component Health Monitor */
        .health-monitor {
            margin-top: 16px;
        }

        .health-item {
            margin-bottom: clamp(14px, 3vw, 16px);
        }

        .health-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: clamp(13px, 2.5vw, 14px);
            color: var(--gray-700);
        }

        .health-value {
            font-weight: 600;
            color: var(--primary);
        }

        .health-bar {
            height: clamp(8px, 1.5vw, 10px);
            background: var(--gray-200);
            border-radius: 10px;
            overflow: hidden;
        }

        .health-progress {
            height: 100%;
            background: var(--success);
            transition: width 0.5s ease;
        }

        .health-score {
            font-size: clamp(18px, 3.5vw, 22px);
            font-weight: 700;
            color: var(--success);
        }

        /* Hardware Test Modal */
        .hardware-test-panel {
            padding: clamp(12px, 2.5vw, 16px) 0;
        }

        .test-section {
            padding: clamp(14px, 3vw, 16px);
            margin-bottom: clamp(14px, 3vw, 16px);
            background: var(--gray-50);
            border-radius: var(--radius);
            border-left: 4px solid var(--primary);
        }

        .test-section h4 {
            color: var(--primary);
            font-size: clamp(15px, 2.8vw, 16px);
            margin-bottom: 12px;
            font-weight: 600;
        }

        .test-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(100%, 120px), 1fr));
            gap: clamp(8px, 1.5vw, 10px);
        }

        .test-control-btn {
            padding: clamp(10px, 2vw, 12px) clamp(12px, 2.5vw, 16px);
            background: white;
            border: 2px solid var(--gray-300);
            border-radius: var(--radius-sm);
            font-size: clamp(12px, 2.2vw, 14px);
            font-weight: 500;
            color: var(--gray-900);
            cursor: pointer;
            transition: all 0.3s;
        }

        .test-control-btn:hover {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        .test-control-btn:active {
            transform: translateY(0);
        }

        .button-test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(100%, 200px), 1fr));
            gap: clamp(10px, 2vw, 12px);
        }

        .button-test-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: clamp(10px, 2vw, 12px);
            background: white;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-sm);
            font-size: clamp(12px, 2.2vw, 13px);
        }

        .button-status {
            font-weight: 600;
        }

        /* Responsive adjustments for hardware tab */
        @media (max-width: 768px) {
            .hardware-status-grid {
                grid-template-columns: 1fr;
            }

            .test-quick-actions {
                grid-template-columns: repeat(2, 1fr);
            }

            .diagram-components {
                grid-template-columns: 1fr;
            }

            .button-test-grid {
                grid-template-columns: 1fr;
            }

            .test-controls {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .hardware-component {
                flex-direction: column;
                text-align: center;
            }

            .component-icon {
                margin: 0 auto;
            }

            .test-quick-actions {
                grid-template-columns: 1fr;
            }

            .test-controls {
                grid-template-columns: 1fr;
            }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--gray-200);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--gray-400);
            border-radius: 10px;
            transition: background 0.2s;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--gray-500);
        }

        /* Floating Chatbot Button */
        .chatbot-float {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary) 0%, #667eea 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
            animation: pulse 2s infinite;
        }

        .chatbot-float:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(79, 70, 229, 0.6);
        }

        .chatbot-float svg {
            width: 30px;
            height: 30px;
            fill: white;
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4);
            }
            50% {
                box-shadow: 0 4px 20px rgba(79, 70, 229, 0.7);
            }
        }

        /* Chatbot Modal Specific Styles */
        .chatbot-modal .modal-content {
            max-width: 600px;
            height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .chatbot-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            background: var(--gray-50);
            border: 1px solid var(--gray-300);
            border-radius: var(--radius);
            margin-bottom: 16px;
        }

        .chatbot-input-area {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }

        @media (max-width: 768px) {
            .chatbot-float {
                bottom: 20px;
                right: 20px;
                width: 50px;
                height: 50px;
            }

            .chatbot-float svg {
                width: 24px;
                height: 24px;
            }

            .chatbot-modal .modal-content {
                height: 90vh;
                max-width: 95vw;
            }
        }

        /* AI Video Call Interface */
        .video-call-interface {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f8fafc;
            z-index: 2000;
            flex-direction: column;
            color: var(--gray-900);
        }

        .video-call-header {
            padding: 16px;
            text-align: center;
            background: var(--white);
            border-bottom: 1px solid var(--gray-300);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .video-call-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        .video-main {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            min-height: 50vh;
            background: var(--gray-100);
        }

        .user-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: var(--gray-200);
            border-radius: 8px;
        }

        .video-sidebar {
            width: 100%;
            background: var(--white);
            display: flex;
            flex-direction: column;
            padding: 16px;
            max-height: 50vh;
            overflow-y: auto;
            border-top: 1px solid var(--gray-300);
        }

        .ai-video-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--success));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            margin: 0 auto 16px;
            animation: breath 3s ease-in-out infinite;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        @keyframes breath {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .video-status {
            text-align: center;
            margin-bottom: 8px;
            font-size: 16px;
            font-weight: 600;
            color: var(--gray-900);
        }

        .video-duration {
            text-align: center;
            opacity: 0.7;
            margin-bottom: 16px;
            font-size: 14px;
            color: var(--gray-600);
        }

        .video-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .video-control-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: 1px solid var(--gray-300);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s ease;
            color: var(--gray-700);
            background: var(--white);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .video-control-btn:hover {
            transform: scale(1.1);
            background: var(--gray-50);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .video-control-btn.muted,
        .video-control-btn.off {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
        }

        .video-end-btn {
            background: #ef4444 !important;
            color: white !important;
            border-color: #ef4444 !important;
        }

        .video-end-btn:hover {
            background: #dc2626 !important;
        }

        .video-transcript {
            flex: 1;
            background: var(--gray-50);
            border-radius: 12px;
            padding: 12px;
            overflow-y: auto;
            font-size: 13px;
            line-height: 1.4;
            min-height: 80px;
            border: 1px solid var(--gray-300);
        }

        .video-analysis-indicator {
            position: absolute;
            top: 16px;
            left: 16px;
            background: var(--primary);
            color: white;
            padding: 10px 12px;
            border-radius: 16px;
            display: none;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4);
        }

        .analysis-pulse {
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        /* AI Phone Call Interface */
        .call-interface {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #f8fafc 0%, #e0e7ff 100%);
            z-index: 2000;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: var(--gray-900);
            padding: 32px;
        }

        .call-content {
            text-align: center;
            max-width: 400px;
            padding: 32px;
            background: var(--white);
            border-radius: 24px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .call-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--success));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 50px;
            margin: 0 auto 24px;
            animation: breath 3s ease-in-out infinite;
            box-shadow: 0 8px 24px rgba(79, 70, 229, 0.3);
        }

        .call-status {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--gray-900);
        }

        .call-duration {
            font-size: 18px;
            opacity: 0.7;
            margin-bottom: 24px;
            color: var(--gray-600);
        }

        .call-controls {
            display: flex;
            gap: 18px;
            justify-content: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .call-control-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 1px solid var(--gray-300);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: all 0.3s ease;
            background: var(--white);
            color: var(--gray-700);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .call-control-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .call-control-btn.muted {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
        }

        .end-call-btn {
            background: #ef4444 !important;
            color: white !important;
            border-color: #ef4444 !important;
        }

        .end-call-btn:hover {
            background: #dc2626 !important;
        }

        .call-transcript {
            background: var(--gray-50);
            border-radius: 15px;
            padding: 20px;
            max-height: 200px;
            overflow-y: auto;
            text-align: left;
            font-size: 14px;
            line-height: 1.5;
            border: 1px solid var(--gray-300);
        }

        .transcript-entry {
            margin-bottom: 12px;
            padding: 10px;
            border-radius: 8px;
        }

        .transcript-user {
            background: var(--primary);
            color: white;
        }

        .transcript-ai {
            background: var(--white);
            border: 1px solid var(--gray-300);
            color: var(--gray-900);
        }

        /* Listening/Speaking Indicators */
        .listening-indicator,
        .speaking-indicator {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            padding: 12px 20px;
            border-radius: 20px;
            display: none;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
            font-size: 14px;
            z-index: 3000;
        }

        .listening-indicator {
            background: rgba(16, 185, 129, 0.9);
        }

        .speaking-indicator {
            background: rgba(79, 70, 229, 0.9);
        }

        .listening-pulse {
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .speaking-bars {
            display: flex;
            gap: 3px;
            align-items: center;
        }

        .speaking-bar {
            width: 3px;
            height: 12px;
            background: white;
            border-radius: 1px;
            animation: speaking 0.8s ease-in-out infinite;
        }

        .speaking-bar:nth-child(2) { animation-delay: 0.1s; }
        .speaking-bar:nth-child(3) { animation-delay: 0.2s; }
        .speaking-bar:nth-child(4) { animation-delay: 0.3s; }

        @keyframes speaking {
            0%, 100% { height: 4px; }
            50% { height: 16px; }
        }

        @media (max-width: 768px) {
            .video-call-content {
                flex-direction: column;
            }

            .video-sidebar {
                width: 100%;
                max-height: 40vh;
            }

            .call-content {
                padding: 16px;
            }

            .call-avatar {
                width: 80px;
                height: 80px;
                font-size: 32px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <span class="logo-icon">🏥</span>
                <span>MediCare Assistant</span>
            </div>
            <button class="hamburger-menu" onclick="toggleMobileMenu()" aria-label="Toggle menu">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <div class="nav-menu" id="navMenu">
                <button class="emergency-btn" onclick="handleEmergency()">🚨 SOS Emergency</button>
                <button class="nav-btn" onclick="openModal('familyPortalModal')">👨‍👩‍👧‍👦 Family</button>
                <button class="nav-btn" onclick="openModal('scanModal')">📷 Scan</button>
                <button class="nav-btn" onclick="openModal('contactModal')">📧 Contact</button>
                <button class="nav-btn" onclick="openModal('aboutModal')">ℹ️ About</button>
                <button class="settings-btn" onclick="openModal('settingsModal')">⚙️ Settings</button>
            </div>
        </div>
    </div>

    <!-- Alert Notification -->
    <div class="alert" id="alertBox">
        <span id="alertIcon"></span>
        <span id="alertText"></span>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Stats Bar -->
        <div class="stats-bar">
            <div class="stat-card">
                <div class="stat-label">Today's Adherence</div>
                <div class="stat-value" id="todayAdherence">0%</div>
                <div class="stat-change">+5% from yesterday</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Current Streak</div>
                <div class="stat-value" id="currentStreak">0</div>
                <div class="stat-change">days in a row</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Next Medication</div>
                <div class="stat-value" id="nextMedTime">--:--</div>
                <div class="stat-change" id="nextMedName">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Device Status</div>
                <div class="stat-value" style="font-size: 18px;" id="deviceStatus">Offline</div>
                <div class="stat-change" id="lastSeen">Never connected</div>
            </div>
        </div>

        <!-- Project Introduction -->
        <div class="intro-section" style="background: white; border: 2px solid var(--gray-200); border-radius: var(--radius); padding: clamp(16px, 3vw, 24px); margin-bottom: clamp(20px, 4vw, 24px);">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                <div style="font-size: clamp(32px, 6vw, 40px);">🏥</div>
                <div>
                    <h2 style="margin: 0; font-size: clamp(18px, 4vw, 22px); font-weight: 600; color: var(--gray-900);">MediCare Assistant</h2>
                    <p style="margin: 4px 0 0 0; font-size: clamp(13px, 2.5vw, 14px); color: var(--gray-600);">AI-Powered Elderly Care & Medication Management</p>
                </div>
            </div>
            <p style="margin: 0; font-size: clamp(13px, 2.5vw, 14px); line-height: 1.6; color: var(--gray-700);">
                An intelligent healthcare system combining <strong>Google Gemini AI</strong> with <strong>ESP32 IoT hardware</strong> for comprehensive medication tracking, real-time health monitoring, and 24/7 assistance.
            </p>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-btn active" onclick="switchTab('dashboard')">Dashboard</button>
            <button class="tab-btn" onclick="switchTab('medications')">Medications</button>
            <button class="tab-btn" onclick="switchTab('schedule')">Schedule</button>
            <button class="tab-btn" onclick="switchTab('hardware')">🔧 Hardware</button>
            <button class="tab-btn" onclick="switchTab('history')">History</button>
            <button class="tab-btn" onclick="switchTab('appointments')">Appointments</button>
            <button class="tab-btn" onclick="switchTab('journal')">Journal</button>
            <button class="tab-btn" onclick="switchTab('analytics')">Analytics</button>
            <button class="tab-btn" onclick="switchTab('documents')">Documents</button>
            <button class="tab-btn" onclick="switchTab('assistant')">AI Assistant</button>
        </div>

        <!-- Dashboard Tab -->
        <div class="tab-content active" id="dashboard">
            <div class="dashboard-grid">
                <!-- Today's Medications -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Today's Medications</h2>
                        <button class="card-action" onclick="openModal('addMedModal')">+ Add</button>
                    </div>
                    <div id="todayMedications">
                        <!-- Medications will be inserted here -->
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Quick Actions</h2>
                    </div>
                    <div class="action-btn-group" style="flex-direction: column; margin-top: 0;">
                        <button class="action-btn" onclick="identifyPill()">📷 Identify Pill</button>
                        <button class="action-btn" onclick="openCamera('document')">📄 Scan Prescription</button>
                        <button class="action-btn" onclick="openChatbotWithVoice()">🎤 Voice Assistant</button>
                        <div style="display: flex; gap: 10px;">
                            <button class="action-btn" onclick="startPhoneCall()" style="flex: 1; background: #10b981;">📞 Call</button>
                            <button class="action-btn" onclick="startVideoCall()" style="flex: 1; background: #3b82f6;">📹 Video</button>
                        </div>
                        <button class="action-btn-secondary" onclick="viewSchedule()" style="width: 100%;">📅 View Full Schedule</button>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Recent Activity</h2>
                    </div>
                    <div id="recentActivity">
                        <p style="text-align: center; color: var(--gray-500); padding: 20px;">No recent activity</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Medications Tab -->
        <div class="tab-content" id="medications">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">All Medications</h2>
                    <button class="card-action" onclick="openModal('addMedModal')">+ Add New</button>
                </div>
                <div id="allMedications">
                    <!-- All medications will be listed here -->
                </div>
            </div>
        </div>

        <!-- Schedule Tab -->
        <div class="tab-content" id="schedule">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Weekly Schedule</h2>
                    <button class="card-action" onclick="exportSchedule()">Export</button>
                </div>
                <div id="weeklySchedule">
                    <!-- Schedule will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Hardware Status Tab -->
        <div class="tab-content" id="hardware">
            <div class="hardware-grid">
                <!-- Hardware Status Overview Card -->
                <div class="card hardware-status-card">
                    <div class="card-header">
                        <h2 class="card-title">🔧 Hardware Status</h2>
                        <button class="card-action" onclick="refreshHardwareStatus()">🔄 Refresh</button>
                    </div>
                    <div class="hardware-status-grid">
                        <div class="hardware-component">
                            <div class="component-icon">📟</div>
                            <div class="component-info">
                                <div class="component-name">ESP32 DevKit V1</div>
                                <div class="component-status" id="esp32Status">
                                    <span class="status-dot status-connected"></span>
                                    <span id="esp32StatusText">Connected</span>
                                </div>
                                <div class="component-detail">WiFi: <span id="wifiStrength">-45 dBm</span></div>
                            </div>
                        </div>

                        <div class="hardware-component">
                            <div class="component-icon">💻</div>
                            <div class="component-info">
                                <div class="component-name">20x4 LCD I2C Display</div>
                                <div class="component-status" id="lcdStatus">
                                    <span class="status-dot status-connected"></span>
                                    <span id="lcdStatusText">Active</span>
                                </div>
                                <div class="component-detail">Address: <span id="lcdAddress">0x27</span></div>
                            </div>
                        </div>

                        <div class="hardware-component">
                            <div class="component-icon">💡</div>
                            <div class="component-info">
                                <div class="component-name">LED Indicators</div>
                                <div class="component-status">
                                    <span class="led-indicator led-red" id="ledRed" title="Red LED"></span>
                                    <span class="led-indicator led-green" id="ledGreen" title="Green LED"></span>
                                    <span class="led-indicator led-blue" id="ledBlue" title="Blue LED"></span>
                                </div>
                                <div class="component-detail">GPIO: 25, 26, 27</div>
                            </div>
                        </div>

                        <div class="hardware-component">
                            <div class="component-icon">🔊</div>
                            <div class="component-info">
                                <div class="component-name">Active Buzzer</div>
                                <div class="component-status" id="buzzerStatus">
                                    <span class="status-dot status-connected"></span>
                                    <span id="buzzerStatusText">Ready</span>
                                </div>
                                <div class="component-detail">GPIO 14 | Volume: <span id="buzzerVolume">80%</span></div>
                            </div>
                        </div>

                        <div class="hardware-component">
                            <div class="component-icon">🎛️</div>
                            <div class="component-info">
                                <div class="component-name">Control Buttons</div>
                                <div class="component-status">
                                    <span class="status-dot status-connected"></span>
                                    <span>4/4 Active</span>
                                </div>
                                <div class="component-detail">GPIO: 32, 33, 35, 34</div>
                            </div>
                        </div>

                        <div class="hardware-component">
                            <div class="component-icon">🎚️</div>
                            <div class="component-info">
                                <div class="component-name">Potentiometer</div>
                                <div class="component-status" id="potStatus">
                                    <span class="status-dot status-connected"></span>
                                    <span id="potStatusText">Active</span>
                                </div>
                                <div class="component-detail">GPIO 36 | Value: <span id="potValue">2048</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Component Testing Card -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">🧪 Component Testing</h2>
                        <button class="card-action" onclick="openModal('hardwareTestModal')">Open Test Panel</button>
                    </div>
                    <div class="test-quick-actions">
                        <button class="test-btn" onclick="testAllLEDs()">
                            <span class="test-icon">💡</span>
                            <span class="test-label">Test LEDs</span>
                        </button>
                        <button class="test-btn" onclick="testBuzzer()">
                            <span class="test-icon">🔊</span>
                            <span class="test-label">Test Buzzer</span>
                        </button>
                        <button class="test-btn" onclick="testLCD()">
                            <span class="test-icon">💻</span>
                            <span class="test-label">Test LCD</span>
                        </button>
                        <button class="test-btn" onclick="testButtons()">
                            <span class="test-icon">🎛️</span>
                            <span class="test-label">Test Buttons</span>
                        </button>
                        <button class="test-btn" onclick="scanI2C()">
                            <span class="test-icon">🔍</span>
                            <span class="test-label">I2C Scanner</span>
                        </button>
                        <button class="test-btn" onclick="testAllComponents()">
                            <span class="test-icon">✅</span>
                            <span class="test-label">Test All</span>
                        </button>
                    </div>
                </div>

                <!-- Hardware Diagram Card -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">📐 System Architecture</h2>
                        <button class="card-action" onclick="toggleDiagramView()">Toggle View</button>
                    </div>
                    <div class="hardware-diagram" id="hardwareDiagram">
                        <div class="diagram-container">
                            <div class="diagram-text">
                                <h3 style="text-align: center; color: var(--primary); margin-bottom: 20px;">Intelligent Elderly Care & Medication Assistant</h3>
                                <div class="diagram-components">
                                    <div class="diagram-section">
                                        <h4>🌐 Cloud Services</h4>
                                        <ul>
                                            <li>Google Gemini AI API</li>
                                            <li>Medication Schedule Management</li>
                                            <li>Web Interface (Camera, Microphone)</li>
                                        </ul>
                                    </div>
                                    <div class="diagram-section">
                                        <h4>🎛️ Main Controller</h4>
                                        <ul>
                                            <li>ESP32 DevKit V1 (Dual-core 240MHz)</li>
                                            <li>WiFi 802.11 b/g/n</li>
                                            <li>Bluetooth v4.2</li>
                                            <li>30 GPIO pins, 4MB Flash</li>
                                        </ul>
                                    </div>
                                    <div class="diagram-section">
                                        <h4>📟 Display & Indicators</h4>
                                        <ul>
                                            <li>20x4 LCD I2C Display (I2C: 0x27)</li>
                                            <li>Red LED (GPIO 25) - Alert</li>
                                            <li>Green LED (GPIO 26) - Confirmed</li>
                                            <li>Blue LED (GPIO 27) - Status</li>
                                        </ul>
                                    </div>
                                    <div class="diagram-section">
                                        <h4>🔊 Audio & Input</h4>
                                        <ul>
                                            <li>Active Buzzer 5V (GPIO 14)</li>
                                            <li>4× Tactile Buttons (GPIO 32-35)</li>
                                            <li>10kΩ Potentiometer (GPIO 36)</li>
                                        </ul>
                                    </div>
                                    <div class="diagram-section">
                                        <h4>🔌 Power & Communication</h4>
                                        <ul>
                                            <li>USB Micro (5V 2A)</li>
                                            <li>HTTP/HTTPS via WiFi</li>
                                            <li>I2C Protocol (SDA: GPIO 21, SCL: GPIO 22)</li>
                                            <li>PWM for LED/Buzzer control</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Component Health Monitor -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">📊 Component Health</h2>
                        <span class="health-score" id="healthScore">95%</span>
                    </div>
                    <div class="health-monitor">
                        <div class="health-item">
                            <div class="health-label">
                                <span>ESP32 Uptime</span>
                                <span class="health-value" id="esp32Uptime">2d 14h 23m</span>
                            </div>
                            <div class="health-bar">
                                <div class="health-progress" style="width: 100%; background: var(--success);"></div>
                            </div>
                        </div>
                        <div class="health-item">
                            <div class="health-label">
                                <span>LCD Brightness</span>
                                <span class="health-value" id="lcdBrightness">85%</span>
                            </div>
                            <div class="health-bar">
                                <div class="health-progress" style="width: 85%; background: var(--success);"></div>
                            </div>
                        </div>
                        <div class="health-item">
                            <div class="health-label">
                                <span>LED Performance</span>
                                <span class="health-value" id="ledPerformance">100%</span>
                            </div>
                            <div class="health-bar">
                                <div class="health-progress" style="width: 100%; background: var(--success);"></div>
                            </div>
                        </div>
                        <div class="health-item">
                            <div class="health-label">
                                <span>Button Response</span>
                                <span class="health-value" id="buttonResponse">98%</span>
                            </div>
                            <div class="health-bar">
                                <div class="health-progress" style="width: 98%; background: var(--success);"></div>
                            </div>
                        </div>
                        <div class="health-item">
                            <div class="health-label">
                                <span>Buzzer Output</span>
                                <span class="health-value" id="buzzerOutput">92%</span>
                            </div>
                            <div class="health-bar">
                                <div class="health-progress" style="width: 92%; background: var(--success);"></div>
                            </div>
                        </div>
                        <div class="health-item">
                            <div class="health-label">
                                <span>WiFi Signal</span>
                                <span class="health-value" id="wifiSignal">Excellent</span>
                            </div>
                            <div class="health-bar">
                                <div class="health-progress" style="width: 90%; background: var(--success);"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div class="tab-content" id="analytics">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Adherence Analytics</h2>
                    <button class="card-action" onclick="downloadReport()">Download Report</button>
                </div>
                <canvas id="adherenceChart" width="400" height="200"></canvas>
            </div>
        </div>

        <!-- Documents Tab -->
        <div class="tab-content" id="documents">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Scanned Documents</h2>
                    <button class="card-action" onclick="openModal('scanModal')">+ Scan New</button>
                </div>
                <div id="documentsList">
                    <p style="text-align: center; color: var(--gray-500); padding: 40px;">No documents scanned yet</p>
                </div>
            </div>
        </div>

        <!-- AI Assistant Tab -->
        <div class="tab-content" id="assistant">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">AI Health Assistant</h2>
                </div>
                <div id="chatMessages" style="min-height: 300px; max-height: 400px; overflow-y: auto; margin-bottom: 16px; padding: 16px; background: var(--gray-50); border: 1px solid var(--gray-300); border-radius: var(--radius);">
                    <div style="padding: 16px; background: #ffffff; border: 1px solid var(--gray-300); border-radius: var(--radius); margin-bottom: 12px;">
                        <strong>AI Assistant:</strong> Hello! I'm your AI health assistant. How can I help you today?
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="chatInput" class="form-input" placeholder="Ask me anything..." onkeypress="handleChatKeyPress(event)" style="flex: 1;">
                    <button class="action-btn" onclick="sendChatMessage()" style="flex: none;">Send</button>
                    <button class="action-btn-secondary" onclick="startVoiceAssistant()" style="flex: none;">Voice</button>
                </div>
            </div>
        </div>

        <!-- Medication History Tab -->
        <div class="tab-content" id="history">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Medication History</h2>
                    <button class="card-action" onclick="exportHistory()">📥 Export</button>
                </div>
                <div style="margin-bottom: 16px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <select id="historyFilter" class="form-select" style="flex: 1; min-width: 150px;" onchange="updateMedicationHistory()">
                        <option value="all">All Medications</option>
                        <option value="taken">Taken Only</option>
                        <option value="missed">Missed Only</option>
                    </select>
                    <input type="date" id="historyDate" class="form-input" style="flex: 1; min-width: 150px;" onchange="updateMedicationHistory()">
                </div>
                <div id="medicationHistory">
                    <!-- History will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Appointments Tab -->
        <div class="tab-content" id="appointments">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Doctor Appointments</h2>
                    <button class="card-action" onclick="openModal('addAppointmentModal')">+ Add</button>
                </div>
                <div id="appointmentsList">
                    <!-- Appointments will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Health Journal Tab -->
        <div class="tab-content" id="journal">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Health Journal</h2>
                    <button class="card-action" onclick="openModal('addJournalModal')">+ New Entry</button>
                </div>
                <div id="journalEntries">
                    <!-- Journal entries will be rendered here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Add Medication Modal -->
    <div class="modal" id="addMedModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Medication</h3>
                <button class="close-modal" onclick="closeModal('addMedModal')">&times;</button>
            </div>
            <form onsubmit="window.editingMedicationId ? updateMedication(event) : addMedication(event); return false;">
                <div class="form-group">
                    <label class="form-label">Medication Name</label>
                    <input type="text" class="form-input" id="medName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Dosage</label>
                    <input type="text" class="form-input" id="medDosage" placeholder="e.g., 1 tablet" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Time</label>
                    <input type="time" class="form-input" id="medTime" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Frequency</label>
                    <select class="form-select" id="medFrequency">
                        <option value="daily">Daily</option>
                        <option value="twice">Twice daily</option>
                        <option value="thrice">Three times daily</option>
                        <option value="weekly">Weekly</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Pill Image (Optional)</label>
                    <input type="file" class="form-input" id="medImage" accept="image/*" onchange="previewMedImage(this)">
                    <div id="medImagePreview" style="margin-top: 10px; text-align: center;"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">Current Stock (Pills)</label>
                    <input type="number" class="form-input" id="medStock" min="0" placeholder="e.g., 30">
                </div>
                <div class="form-group">
                    <label class="form-label">Refill Alert When Below</label>
                    <input type="number" class="form-input" id="medRefillAlert" min="0" placeholder="e.g., 7">
                </div>
                <div class="action-btn-group">
                    <button type="submit" class="action-btn">Add Medication</button>
                    <button type="button" class="action-btn-secondary" onclick="closeModal('addMedModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scan Document Modal -->
    <div class="modal" id="scanModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Scan Document</h3>
                <button class="close-modal" onclick="closeModal('scanModal')">&times;</button>
            </div>
            <div class="video-container">
                <video id="scanVideo" class="video-preview" autoplay playsinline></video>
                <canvas id="scanCanvas" style="display: none;"></canvas>
            </div>
            <div class="video-controls">
                <button class="action-btn" onclick="captureDocument()">Capture</button>
                <button class="action-btn-secondary" onclick="switchCamera()">Switch Camera</button>
                <button class="action-btn-secondary" onclick="closeScanner()">Close</button>
            </div>
            <div class="loading" id="scanLoading">
                <div class="spinner"></div>
                <div class="loading-text">Analyzing document...</div>
            </div>
            <div id="scanResult" style="margin-top: 20px;"></div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Settings</h3>
                <button class="close-modal" onclick="closeModal('settingsModal')">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label">Google Gemini API Key</label>
                <input type="password" class="form-input" id="apiKey" placeholder="Enter your API key">
                <small style="color: var(--gray-500); font-size: 12px;">Get your key from <a href="https://aistudio.google.com/" target="_blank" style="color: var(--primary);">Google AI Studio</a></small>
            </div>
            <div class="form-group">
                <label class="form-label">Patient Name</label>
                <input type="text" class="form-input" id="patientName">
            </div>
            <div class="form-group">
                <label class="form-label">Emergency Contact</label>
                <input type="tel" class="form-input" id="emergencyContact" placeholder="+27 XX XXX XXXX">
            </div>
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" id="esp32Enable" style="width: auto; cursor: pointer;">
                    <span class="form-label" style="margin: 0;">Connect to ESP32 Device</span>
                </label>
                <small style="color: var(--gray-500); font-size: 12px;">Enable this only if you have an ESP32 hardware device</small>
            </div>
            <div class="form-group" id="esp32UrlGroup" style="display: none;">
                <label class="form-label">ESP32 Device URL</label>
                <input type="text" class="form-input" id="esp32Url" placeholder="http://192.168.1.100">
                <small style="color: var(--gray-500); font-size: 12px;">Find the IP address on your device's LCD screen</small>
            </div>
            <div class="form-group">
                <label class="form-label">Reminder Volume: <span id="volumeDisplay">80%</span></label>
                <input type="range" class="form-input" id="reminderVolume" min="0" max="100" value="80" oninput="updateVolumeDisplay(this.value)">
            </div>
            <div class="form-group">
                <label class="form-label">Language</label>
                <select class="form-select" id="appLanguage" onchange="changeLanguage(this.value)">
                    <option value="en">English</option>
                    <option value="es">Español (Spanish)</option>
                    <option value="fr">Français (French)</option>
                    <option value="de">Deutsch (German)</option>
                    <option value="pt">Português (Portuguese)</option>
                    <option value="zh">中文 (Chinese)</option>
                </select>
            </div>
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()" style="width: auto; cursor: pointer;">
                    <span class="form-label" style="margin: 0;">🌙 Dark Mode</span>
                </label>
            </div>
            <div class="form-group">
                <label class="form-label">Notification Sound</label>
                <select class="form-select" id="notificationSound">
                    <option value="beep">Beep (Default)</option>
                    <option value="chime">Chime</option>
                    <option value="bell">Bell</option>
                    <option value="gentle">Gentle Alert</option>
                </select>
            </div>
            <div class="action-btn-group">
                <button class="action-btn" onclick="saveSettings()">Save Settings</button>
                <button class="action-btn-secondary" onclick="closeModal('settingsModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Contact/Feedback Modal -->
    <div class="modal" id="contactModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Contact & Feedback</h3>
                <button class="close-modal" onclick="closeModal('contactModal')">&times;</button>
            </div>
            <form id="contactForm" action="https://formspree.io/f/xrbygvga" method="POST">
                <div class="form-group">
                    <label class="form-label">Your Name</label>
                    <input type="text" class="form-input" name="name" id="contactName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" class="form-input" name="email" id="contactEmail" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Subject</label>
                    <select class="form-select" name="subject" id="contactSubject" required>
                        <option value="">Select a subject...</option>
                        <option value="feedback">General Feedback</option>
                        <option value="bug">Report a Bug</option>
                        <option value="feature">Feature Request</option>
                        <option value="help">Need Help</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Message</label>
                    <textarea class="form-textarea" name="message" id="contactMessage" required rows="5" placeholder="Tell us what's on your mind..."></textarea>
                </div>
                <input type="hidden" name="_subject" value="MediCare Assistant - New Contact Form Submission">
                <input type="hidden" name="_next" value="#contact-success">
                <input type="hidden" name="timestamp" id="contactTimestamp">
                <div class="action-btn-group">
                    <button type="submit" class="action-btn" id="submitContactBtn">Send Message</button>
                    <button type="button" class="action-btn-secondary" onclick="closeModal('contactModal')">Cancel</button>
                </div>
            </form>
            <div id="contactSuccess" style="display: none; text-align: center; padding: 20px;">
                <div style="font-size: 48px; margin-bottom: 16px;">✅</div>
                <h3 style="color: var(--success); margin-bottom: 12px;">Message Sent!</h3>
                <p style="color: var(--gray-600);">Thank you for your feedback. We'll get back to you soon.</p>
            </div>
        </div>
    </div>

    <!-- Add Appointment Modal -->
    <div class="modal" id="addAppointmentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Appointment</h3>
                <button class="close-modal" onclick="closeModal('addAppointmentModal')">&times;</button>
            </div>
            <form onsubmit="addAppointment(event); return false;">
                <div class="form-group">
                    <label class="form-label">Doctor/Clinic Name</label>
                    <input type="text" class="form-input" id="appointmentDoctor" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Appointment Type</label>
                    <select class="form-select" id="appointmentType">
                        <option value="checkup">Regular Check-up</option>
                        <option value="followup">Follow-up</option>
                        <option value="specialist">Specialist</option>
                        <option value="lab">Lab Test</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Date & Time</label>
                    <input type="datetime-local" class="form-input" id="appointmentDateTime" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Location</label>
                    <input type="text" class="form-input" id="appointmentLocation" placeholder="Hospital/Clinic address">
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-textarea" id="appointmentNotes" rows="3" placeholder="Reason for visit, preparation instructions, etc."></textarea>
                </div>
                <div class="action-btn-group">
                    <button type="submit" class="action-btn">Add Appointment</button>
                    <button type="button" class="action-btn-secondary" onclick="closeModal('addAppointmentModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Journal Entry Modal -->
    <div class="modal" id="addJournalModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">New Health Journal Entry</h3>
                <button class="close-modal" onclick="closeModal('addJournalModal')">&times;</button>
            </div>
            <form onsubmit="addJournalEntry(event); return false;">
                <div class="form-group">
                    <label class="form-label">Date</label>
                    <input type="date" class="form-input" id="journalDate" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Mood</label>
                    <select class="form-select" id="journalMood">
                        <option value="great">😊 Great</option>
                        <option value="good">🙂 Good</option>
                        <option value="okay">😐 Okay</option>
                        <option value="bad">😞 Not Good</option>
                        <option value="terrible">😢 Terrible</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Symptoms (if any)</label>
                    <input type="text" class="form-input" id="journalSymptoms" placeholder="e.g., Headache, Fatigue">
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-textarea" id="journalNotes" rows="5" placeholder="How are you feeling? Any side effects? What happened today?" required></textarea>
                </div>
                <div class="action-btn-group">
                    <button type="submit" class="action-btn">Save Entry</button>
                    <button type="button" class="action-btn-secondary" onclick="closeModal('addJournalModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Hardware Test Modal -->
    <div class="modal" id="hardwareTestModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">🧪 Hardware Component Testing</h3>
                <button class="close-modal" onclick="closeModal('hardwareTestModal')">&times;</button>
            </div>
            <div class="hardware-test-panel">
                <div class="test-section">
                    <h4>💡 LED Testing</h4>
                    <div class="test-controls">
                        <button class="test-control-btn" onclick="toggleLED('red')">🔴 Red LED</button>
                        <button class="test-control-btn" onclick="toggleLED('green')">🟢 Green LED</button>
                        <button class="test-control-btn" onclick="toggleLED('blue')">🔵 Blue LED</button>
                        <button class="test-control-btn" onclick="cycleAllLEDs()">🔄 Cycle All</button>
                    </div>
                </div>
                <div class="test-section">
                    <h4>🔊 Buzzer Testing</h4>
                    <div class="test-controls">
                        <button class="test-control-btn" onclick="playTone('short')">Short Beep</button>
                        <button class="test-control-btn" onclick="playTone('long')">Long Beep</button>
                        <button class="test-control-btn" onclick="playTone('pattern')">Pattern</button>
                        <button class="test-control-btn" onclick="stopBuzzer()">⏹️ Stop</button>
                    </div>
                    <div class="form-group" style="margin-top: 12px;">
                        <label class="form-label">Test Volume: <span id="testVolume">80%</span></label>
                        <input type="range" class="form-input" min="0" max="100" value="80" oninput="updateTestVolume(this.value)">
                    </div>
                </div>
                <div class="test-section">
                    <h4>💻 LCD Display Testing</h4>
                    <div class="test-controls">
                        <button class="test-control-btn" onclick="displayTestPattern()">Test Pattern</button>
                        <button class="test-control-btn" onclick="displayCustomText()">Custom Text</button>
                        <button class="test-control-btn" onclick="clearLCD()">Clear Display</button>
                        <button class="test-control-btn" onclick="adjustLCDBacklight()">💡 Backlight</button>
                    </div>
                    <div class="form-group" style="margin-top: 12px;">
                        <input type="text" class="form-input" id="lcdCustomText" placeholder="Enter custom text (max 80 chars)" maxlength="80">
                    </div>
                </div>
                <div class="test-section">
                    <h4>🎛️ Button Testing</h4>
                    <div class="button-test-grid">
                        <div class="button-test-item">
                            <span>Button 1 (GPIO 32)</span>
                            <span class="button-status" id="btn1Status">⚪ Waiting...</span>
                        </div>
                        <div class="button-test-item">
                            <span>Button 2 (GPIO 33)</span>
                            <span class="button-status" id="btn2Status">⚪ Waiting...</span>
                        </div>
                        <div class="button-test-item">
                            <span>Button 3 (GPIO 35)</span>
                            <span class="button-status" id="btn3Status">⚪ Waiting...</span>
                        </div>
                        <div class="button-test-item">
                            <span>Button 4 (GPIO 34)</span>
                            <span class="button-status" id="btn4Status">⚪ Waiting...</span>
                        </div>
                    </div>
                    <button class="test-control-btn" onclick="startButtonTest()" style="width: 100%; margin-top: 12px;">Start Button Test</button>
                </div>
                <div class="test-section">
                    <h4>🔍 I2C Scanner</h4>
                    <button class="test-control-btn" onclick="runI2CScan()" style="width: 100%;">Scan I2C Bus</button>
                    <div id="i2cResults" style="margin-top: 12px; padding: 12px; background: var(--gray-50); border-radius: var(--radius-sm); font-family: monospace; font-size: 12px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Family Portal Modal -->
    <div class="modal" id="familyPortalModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Family Portal</h3>
                <button class="close-modal" onclick="closeModal('familyPortalModal')">&times;</button>
            </div>
            <div style="text-align: center; margin-bottom: 24px;">
                <div style="font-size: 48px; margin-bottom: 16px;">👨‍👩‍👧‍👦</div>
                <p style="color: var(--gray-600);">Share your medication status with family members</p>
            </div>
            <div id="familyShareLink" style="margin-bottom: 20px;">
                <!-- Share link will be generated here -->
            </div>
            <div class="form-group">
                <label class="form-label">Generate Share Link</label>
                <button class="action-btn" onclick="generateFamilyLink()" style="width: 100%;">🔗 Generate Shareable Link</button>
            </div>
            <div id="currentFamilyMembers" style="margin-top: 20px;">
                <h4 style="color: var(--primary); margin-bottom: 12px;">Connected Family Members</h4>
                <!-- Family members list will be rendered here -->
                <p style="text-align: center; color: var(--gray-500); padding: 20px;">No family members connected yet</p>
            </div>
            <div class="action-btn-group" style="margin-top: 24px;">
                <button class="action-btn-secondary" onclick="closeModal('familyPortalModal')" style="width: 100%;">Close</button>
            </div>
        </div>
    </div>

    <!-- About Modal -->
    <div class="modal" id="aboutModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">About MediCare Assistant</h3>
                <button class="close-modal" onclick="closeModal('aboutModal')">&times;</button>
            </div>

            <div style="text-align: center; margin-bottom: 24px;">
                <div style="font-size: 64px; margin-bottom: 16px;">🏥</div>
                <h2 style="color: var(--primary); margin-bottom: 8px;">MediCare Assistant</h2>
                <p style="color: var(--gray-600); font-size: 14px;">Version 2.0.0 - Hardware Integration Edition</p>
            </div>

            <div style="background: var(--gray-50); padding: 20px; border-radius: var(--radius); margin-bottom: 20px;">
                <h3 style="color: var(--primary); margin-bottom: 12px; font-size: 18px;">🎯 Our Mission</h3>
                <p style="color: var(--gray-700); line-height: 1.6; margin-bottom: 0;">
                    MediCare Assistant is an intelligent elderly care and medication management system designed to help seniors
                    maintain medication adherence, stay connected with healthcare providers, and manage their health independently
                    with the power of AI.
                </p>
            </div>

            <div style="margin-bottom: 24px;">
                <h3 style="color: var(--primary); margin-bottom: 16px; font-size: 18px;">✨ Key Features</h3>
                <div style="display: grid; gap: 12px;">
                    <div style="display: flex; align-items: start; gap: 12px; padding: 12px; background: var(--gray-50); border-radius: var(--radius-sm);">
                        <span style="font-size: 24px;">💊</span>
                        <div>
                            <strong style="color: var(--gray-900);">Smart Medication Tracking</strong>
                            <p style="color: var(--gray-600); font-size: 13px; margin: 4px 0 0 0;">Schedule, track, and get reminders for all your medications</p>
                        </div>
                    </div>
                    <div style="display: flex; align-items: start; gap: 12px; padding: 12px; background: var(--gray-50); border-radius: var(--radius-sm);">
                        <span style="font-size: 24px;">🤖</span>
                        <div>
                            <strong style="color: var(--gray-900);">AI Health Assistant</strong>
                            <p style="color: var(--gray-600); font-size: 13px; margin: 4px 0 0 0;">24/7 AI chatbot powered by Google Gemini for health questions</p>
                        </div>
                    </div>
                    <div style="display: flex; align-items: start; gap: 12px; padding: 12px; background: var(--gray-50); border-radius: var(--radius-sm);">
                        <span style="font-size: 24px;">📞</span>
                        <div>
                            <strong style="color: var(--gray-900);">AI Voice & Video Calls</strong>
                            <p style="color: var(--gray-600); font-size: 13px; margin: 4px 0 0 0;">Connect with AI assistant via phone or video call with real-time transcription</p>
                        </div>
                    </div>
                    <div style="display: flex; align-items: start; gap: 12px; padding: 12px; background: var(--gray-50); border-radius: var(--radius-sm);">
                        <span style="font-size: 24px;">📷</span>
                        <div>
                            <strong style="color: var(--gray-900);">Document & Pill Scanner</strong>
                            <p style="color: var(--gray-600); font-size: 13px; margin: 4px 0 0 0;">Scan prescriptions and identify pills using AI image recognition</p>
                        </div>
                    </div>
                    <div style="display: flex; align-items: start; gap: 12px; padding: 12px; background: var(--gray-50); border-radius: var(--radius-sm);">
                        <span style="font-size: 24px;">🎤</span>
                        <div>
                            <strong style="color: var(--gray-900);">Voice Recognition</strong>
                            <p style="color: var(--gray-600); font-size: 13px; margin: 4px 0 0 0;">Hands-free interaction with voice commands and responses</p>
                        </div>
                    </div>
                    <div style="display: flex; align-items: start; gap: 12px; padding: 12px; background: var(--gray-50); border-radius: var(--radius-sm);">
                        <span style="font-size: 24px;">📊</span>
                        <div>
                            <strong style="color: var(--gray-900);">Adherence Analytics</strong>
                            <p style="color: var(--gray-600); font-size: 13px; margin: 4px 0 0 0;">Track medication adherence patterns and maintain streaks</p>
                        </div>
                    </div>
                    <div style="display: flex; align-items: start; gap: 12px; padding: 12px; background: var(--gray-50); border-radius: var(--radius-sm);">
                        <span style="font-size: 24px;">🚨</span>
                        <div>
                            <strong style="color: var(--gray-900);">Emergency SOS</strong>
                            <p style="color: var(--gray-600); font-size: 13px; margin: 4px 0 0 0;">Quick access to emergency contacts and services</p>
                        </div>
                    </div>
                    <div style="display: flex; align-items: start; gap: 12px; padding: 12px; background: var(--gray-50); border-radius: var(--radius-sm);">
                        <span style="font-size: 24px;">🔌</span>
                        <div>
                            <strong style="color: var(--gray-900);">ESP32 Hardware Integration</strong>
                            <p style="color: var(--gray-600); font-size: 13px; margin: 4px 0 0 0;">Connect to ESP32 DevKit V1 with 20x4 LCD, LEDs, buzzer, and buttons for enhanced physical automation</p>
                        </div>
                    </div>
                    <div style="display: flex; align-items: start; gap: 12px; padding: 12px; background: var(--gray-50); border-radius: var(--radius-sm);">
                        <span style="font-size: 24px;">🔧</span>
                        <div>
                            <strong style="color: var(--gray-900);">Hardware Testing Suite</strong>
                            <p style="color: var(--gray-600); font-size: 13px; margin: 4px 0 0 0;">Real-time monitoring and testing of all hardware components with I2C scanner</p>
                        </div>
                    </div>
                    <div style="display: flex; align-items: start; gap: 12px; padding: 12px; background: var(--gray-50); border-radius: var(--radius-sm);">
                        <span style="font-size: 24px;">📦</span>
                        <div>
                            <strong style="color: var(--gray-900);">Refill Reminders & Stock Tracking</strong>
                            <p style="color: var(--gray-600); font-size: 13px; margin: 4px 0 0 0;">Track medication stock levels and receive alerts when refills are needed</p>
                        </div>
                    </div>
                    <div style="display: flex; align-items: start; gap: 12px; padding: 12px; background: var(--gray-50); border-radius: var(--radius-sm);">
                        <span style="font-size: 24px;">👨‍👩‍👧‍👦</span>
                        <div>
                            <strong style="color: var(--gray-900);">Family Portal</strong>
                            <p style="color: var(--gray-600); font-size: 13px; margin: 4px 0 0 0;">Share medication history and adherence data with family members</p>
                        </div>
                    </div>
                    <div style="display: flex; align-items: start; gap: 12px; padding: 12px; background: var(--gray-50); border-radius: var(--radius-sm);">
                        <span style="font-size: 24px;">🗓️</span>
                        <div>
                            <strong style="color: var(--gray-900);">Appointments & Health Journal</strong>
                            <p style="color: var(--gray-600); font-size: 13px; margin: 4px 0 0 0;">Schedule appointments and maintain a daily health journal</p>
                        </div>
                    </div>
                    <div style="display: flex; align-items: start; gap: 12px; padding: 12px; background: var(--gray-50); border-radius: var(--radius-sm);">
                        <span style="font-size: 24px;">🌍</span>
                        <div>
                            <strong style="color: var(--gray-900);">Multi-Language Support</strong>
                            <p style="color: var(--gray-600); font-size: 13px; margin: 4px 0 0 0;">Available in English, Spanish, French, German, Portuguese, and Chinese</p>
                        </div>
                    </div>
                    <div style="display: flex; align-items: start; gap: 12px; padding: 12px; background: var(--gray-50); border-radius: var(--radius-sm);">
                        <span style="font-size: 24px;">🌙</span>
                        <div>
                            <strong style="color: var(--gray-900);">Dark Mode & Customization</strong>
                            <p style="color: var(--gray-600); font-size: 13px; margin: 4px 0 0 0;">Switch between light and dark themes with customizable notification sounds</p>
                        </div>
                    </div>
                </div>
            </div>

            <div style="margin-bottom: 24px;">
                <h3 style="color: var(--primary); margin-bottom: 16px; font-size: 18px;">🛠️ Technologies Used</h3>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    <span style="background: var(--primary); color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 500;">Google Gemini AI</span>
                    <span style="background: #e74c3c; color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 500;">ESP32 DevKit V1</span>
                    <span style="background: #3498db; color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 500;">I2C Protocol</span>
                    <span style="background: var(--success); color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 500;">Web Speech API</span>
                    <span style="background: var(--warning); color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 500;">MediaDevices API</span>
                    <span style="background: var(--danger); color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 500;">WebRTC</span>
                    <span style="background: #9b59b6; color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 500;">Web Audio API</span>
                    <span style="background: #16a085; color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 500;">PWM Control</span>
                    <span style="background: var(--gray-600); color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 500;">Local Storage</span>
                    <span style="background: var(--primary); color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 500;">Responsive Design</span>
                    <span style="background: #e67e22; color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 500;">WiFi Integration</span>
                </div>
            </div>

            <div style="margin-bottom: 24px;">
                <h3 style="color: var(--primary); margin-bottom: 16px; font-size: 18px;">⚙️ Hardware Specifications (Optional)</h3>
                <div style="background: var(--gray-50); padding: 16px; border-radius: var(--radius); border-left: 4px solid var(--primary);">
                    <div style="display: grid; gap: 10px;">
                        <div style="display: flex; justify-content: space-between; padding: 8px; background: white; border-radius: 6px;">
                            <span style="color: var(--gray-700); font-size: 13px;"><strong>Main Controller:</strong></span>
                            <span style="color: var(--gray-600); font-size: 13px;">ESP32 DevKit V1 (240MHz Dual-Core)</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px; background: white; border-radius: 6px;">
                            <span style="color: var(--gray-700); font-size: 13px;"><strong>Display:</strong></span>
                            <span style="color: var(--gray-600); font-size: 13px;">20x4 LCD I2C (Address: 0x27)</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px; background: white; border-radius: 6px;">
                            <span style="color: var(--gray-700); font-size: 13px;"><strong>Indicators:</strong></span>
                            <span style="color: var(--gray-600); font-size: 13px;">3× RGB LEDs (GPIO 25, 26, 27)</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px; background: white; border-radius: 6px;">
                            <span style="color: var(--gray-700); font-size: 13px;"><strong>Audio:</strong></span>
                            <span style="color: var(--gray-600); font-size: 13px;">Active Buzzer 5V (GPIO 14)</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px; background: white; border-radius: 6px;">
                            <span style="color: var(--gray-700); font-size: 13px;"><strong>Inputs:</strong></span>
                            <span style="color: var(--gray-600); font-size: 13px;">4× Buttons + Potentiometer</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px; background: white; border-radius: 6px;">
                            <span style="color: var(--gray-700); font-size: 13px;"><strong>Connectivity:</strong></span>
                            <span style="color: var(--gray-600); font-size: 13px;">WiFi 802.11 b/g/n + Bluetooth 4.2</span>
                        </div>
                    </div>
                </div>
            </div>

            <div style="background: linear-gradient(135deg, var(--primary) 0%, #667eea 100%); padding: 20px; border-radius: var(--radius); margin-bottom: 20px; color: white; text-align: center;">
                <h3 style="margin: 0 0 8px 0; font-size: 18px;">💡 Privacy & Security</h3>
                <p style="margin: 0; font-size: 13px; opacity: 0.95; line-height: 1.5;">
                    All your data is stored locally on your device. Your API key and health information never leave your browser.
                    We respect your privacy and security.
                </p>
            </div>

            <div style="text-align: center; padding: 16px; background: var(--gray-50); border-radius: var(--radius);">
                <p style="color: var(--gray-600); font-size: 13px; margin: 0 0 8px 0;">
                    <strong>Developed with ❤️ for elderly care</strong>
                </p>
                <p style="color: var(--gray-500); font-size: 12px; margin: 0;">
                    &copy; 2025 MediCare Assistant. All rights reserved.
                </p>
            </div>

            <div class="action-btn-group" style="margin-top: 24px;">
                <button class="action-btn" onclick="openModal('contactModal'); closeModal('aboutModal');" style="width: 100%;">
                    📧 Contact Us
                </button>
                <button class="action-btn-secondary" onclick="closeModal('aboutModal')" style="width: 100%;">
                    Close
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        let geminiApiKey = 'AIzaSyDBzJeHlB5ayYe0iiM0bN9BtIn09Udnz6Y'; // From reference 23.html
        let esp32BaseUrl = ''; // Optional - set in settings if you have ESP32 device
        let esp32Connected = false;
        let esp32Enabled = false; // Only try to connect if user enables it
        let websocket = null;
        let medications = [];
        let currentStream = null;
        let currentCamera = 'environment';
        let adherenceData = { taken: 0, total: 0, streak: 0, lastReset: new Date().toDateString() };
        let offlineQueue = [];
        let reconnectAttempts = 0;
        let maxReconnectAttempts = 3;

        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            loadMedications();
            checkDailyReset();
            updateDashboard();
            startReminderSystem();
            initScrollBehavior();
            initESP32Toggle();

            // Only connect to ESP32 if enabled and URL is set
            if (esp32Enabled && esp32BaseUrl) {
                connectToESP32();
                initWebSocket();
            } else {
                console.log('💡 Running in standalone mode (no ESP32 device)');
                document.getElementById('deviceStatus').textContent = 'Standalone';
                document.getElementById('deviceStatus').style.color = 'var(--gray-500)';
                document.getElementById('lastSeen').textContent = 'No device configured';
            }

            console.log('✅ MediCare Assistant initialized successfully');
        });

        // Auto-hide/show Header on Scroll
        function initScrollBehavior() {
            let lastScrollTop = 0;
            let scrollThreshold = 10;
            const header = document.querySelector('.header');

            window.addEventListener('scroll', function() {
                let scrollTop = window.pageYOffset || document.documentElement.scrollTop;

                // Scrolling down
                if (scrollTop > lastScrollTop && scrollTop > scrollThreshold) {
                    header.classList.add('hidden');
                }
                // Scrolling up
                else if (scrollTop < lastScrollTop) {
                    header.classList.remove('hidden');
                }

                // Always show at top
                if (scrollTop <= scrollThreshold) {
                    header.classList.remove('hidden');
                }

                lastScrollTop = scrollTop <= 0 ? 0 : scrollTop;
            }, { passive: true });
        }

        // Input Validation & Sanitization
        function sanitizeInput(input) {
            if (typeof input !== 'string') return '';
            return input.replace(/[<>]/g, '').trim();
        }

        function validateMedicationData(data) {
            if (!data.name || data.name.trim().length === 0) {
                throw new Error('Medication name is required');
            }
            if (!data.dosage || data.dosage.trim().length === 0) {
                throw new Error('Dosage is required');
            }
            if (!data.time || !/^\d{2}:\d{2}$/.test(data.time)) {
                throw new Error('Valid time is required (HH:MM)');
            }
            return true;
        }

        function validateTimeFormat(time) {
            const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/;
            return timeRegex.test(time);
        }

        // Daily Reset Check
        function checkDailyReset() {
            const today = new Date().toDateString();
            if (adherenceData.lastReset !== today) {
                // Reset all medications to "not taken" for new day
                medications.forEach(med => {
                    if (med.taken) {
                        med.takenToday = false;
                        med.taken = false;
                    }
                });
                adherenceData.lastReset = today;
                saveMedications();
                console.log('Daily reset completed');
            }
        }

        // ESP32 Connection Management
        async function connectToESP32() {
            if (!esp32BaseUrl || !esp32Enabled) {
                console.log('ESP32 not configured or disabled');
                return;
            }

            const savedUrl = localStorage.getItem('esp32BaseUrl');
            if (savedUrl) {
                esp32BaseUrl = savedUrl;
            }

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);

                const response = await fetch(`${esp32BaseUrl}/api/status`, {
                    method: 'GET',
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (response.ok) {
                    esp32Connected = true;
                    document.getElementById('deviceStatus').textContent = 'Online';
                    document.getElementById('deviceStatus').style.color = 'var(--success)';
                    document.getElementById('lastSeen').textContent = 'Connected';
                    reconnectAttempts = 0;
                    processOfflineQueue();
                    showAlert('Connected to ESP32 device!', 'success');
                } else {
                    throw new Error('Connection failed');
                }
            } catch (error) {
                esp32Connected = false;
                document.getElementById('deviceStatus').textContent = 'Offline';
                document.getElementById('deviceStatus').style.color = 'var(--danger)';

                // Only log first attempt to avoid spam
                if (reconnectAttempts === 0) {
                    console.log('💡 ESP32 device not found - running in standalone mode');
                    console.log('To connect: Set ESP32 URL in Settings and click "Connect Device"');
                }

                scheduleReconnect();
            }
        }

        function scheduleReconnect() {
            if (reconnectAttempts < maxReconnectAttempts && esp32Enabled) {
                reconnectAttempts++;
                const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
                setTimeout(connectToESP32, delay);
            } else if (reconnectAttempts >= maxReconnectAttempts) {
                console.log('💡 Max reconnection attempts reached. Working in standalone mode.');
                console.log('💡 To retry: Enable "Connect to ESP32" in Settings');
            }
        }

        // ESP32 API Client
        async function esp32Request(endpoint, method = 'GET', data = null) {
            if (!esp32Connected) {
                console.warn('ESP32 offline, queueing request');
                offlineQueue.push({ endpoint, method, data, timestamp: Date.now() });
                return { offline: true };
            }

            try {
                const options = {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    timeout: 10000
                };

                if (data) {
                    options.body = JSON.stringify(data);
                }

                const response = await fetch(`${esp32BaseUrl}${endpoint}`, options);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                return await response.json();
            } catch (error) {
                console.error('ESP32 request failed:', error);
                esp32Connected = false;
                scheduleReconnect();
                offlineQueue.push({ endpoint, method, data, timestamp: Date.now() });
                throw error;
            }
        }

        async function processOfflineQueue() {
            if (offlineQueue.length === 0) return;

            console.log(`Processing ${offlineQueue.length} offline actions`);
            const queue = [...offlineQueue];
            offlineQueue = [];

            for (const item of queue) {
                try {
                    await esp32Request(item.endpoint, item.method, item.data);
                } catch (error) {
                    console.error('Failed to process queued item:', error);
                }
            }
        }

        // WebSocket for Real-time Updates
        function initWebSocket() {
            if (!esp32BaseUrl || !esp32Enabled || !esp32Connected) {
                return;
            }

            const wsUrl = esp32BaseUrl.replace('http', 'ws') + '/ws';

            try {
                websocket = new WebSocket(wsUrl);

                websocket.onopen = () => {
                    console.log('✅ WebSocket connected to ESP32');
                };

                websocket.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        handleWebSocketMessage(data);
                    } catch (error) {
                        console.error('WebSocket message parse error:', error);
                    }
                };

                websocket.onerror = (error) => {
                    // Silent - expected when ESP32 not connected
                };

                websocket.onclose = () => {
                    if (esp32Connected && esp32Enabled) {
                        setTimeout(initWebSocket, 10000); // Retry every 10s
                    }
                };
            } catch (error) {
                // Silent - expected when ESP32 not available
            }
        }

        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'medication_alert':
                    showReminder(data.medication);
                    break;
                case 'medication_confirmed':
                    updateDashboard();
                    break;
                case 'button_pressed':
                    handlePhysicalButton(data.button);
                    break;
                case 'status_update':
                    updateDeviceStatus(data.status);
                    break;
                default:
                    console.log('Unknown WebSocket message:', data);
            }
        }

        function handlePhysicalButton(buttonId) {
            if (buttonId === 1) {
                // Confirm current medication
                const nextMed = medications.filter(m => !m.taken).sort((a, b) => a.time.localeCompare(b.time))[0];
                if (nextMed) {
                    confirmMedication(nextMed.id);
                }
            }
        }

        function updateDeviceStatus(status) {
            document.getElementById('deviceStatus').textContent = status.online ? 'Online' : 'Offline';
            document.getElementById('deviceStatus').style.color = status.online ? 'var(--success)' : 'var(--danger)';
        }

        // Tab Switching
        function switchTab(tabName) {
            // Stop audio when switching away from assistant tab
            if (tabName !== 'assistant') {
                stopAllAudioAndRecognition();
            }

            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));

            document.getElementById(tabName).classList.add('active');

            // Find and activate the corresponding button
            const buttons = document.querySelectorAll('.tab-btn');
            buttons.forEach(btn => {
                if (btn.textContent.toLowerCase().includes(tabName.toLowerCase()) ||
                    btn.getAttribute('onclick').includes(tabName)) {
                    btn.classList.add('active');
                }
            });

            // Update content when switching tabs
            if (tabName === 'medications') updateAllMedications();
            if (tabName === 'schedule') updateWeeklySchedule();
            if (tabName === 'analytics') updateAnalytics();
        }

        // Modal Management
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Show Alert
        function showAlert(message, type = 'info') {
            const alertBox = document.getElementById('alertBox');
            const alertText = document.getElementById('alertText');
            const alertIcon = document.getElementById('alertIcon');

            alertBox.className = `alert alert-${type} active`;
            alertText.textContent = message;
            alertIcon.textContent = type === 'success' ? '✓' : type === 'error' ? '✕' : 'ℹ';

            setTimeout(() => {
                alertBox.classList.remove('active');
            }, 4000);
        }

        // Add Medication
        async function addMedication(event) {
            event.preventDefault();

            try {
                const medication = {
                    id: Date.now(),
                    name: sanitizeInput(document.getElementById('medName').value),
                    dosage: sanitizeInput(document.getElementById('medDosage').value),
                    time: document.getElementById('medTime').value,
                    frequency: document.getElementById('medFrequency').value,
                    taken: false,
                    createdAt: new Date().toISOString()
                };

                // Validate data
                validateMedicationData(medication);

                // Add to local storage
                medications.push(medication);
                saveMedications();

                // Sync to ESP32
                try {
                    await esp32Request('/api/medications', 'POST', medication);
                } catch (error) {
                    console.warn('Failed to sync to ESP32, will retry later');
                }

                updateDashboard();
                closeModal('addMedModal');
                showAlert('Medication added successfully!', 'success');
                event.target.reset();

            } catch (error) {
                showAlert(error.message, 'error');
            }
        }

        // Edit Medication
        async function editMedication(id) {
            const med = medications.find(m => m.id === id);
            if (!med) return;

            document.getElementById('medName').value = med.name;
            document.getElementById('medDosage').value = med.dosage;
            document.getElementById('medTime').value = med.time;
            document.getElementById('medFrequency').value = med.frequency;

            // Change modal to edit mode
            const modal = document.getElementById('addMedModal');
            const title = modal.querySelector('.modal-title');
            const submitBtn = modal.querySelector('button[type="submit"]');

            title.textContent = 'Edit Medication';
            submitBtn.textContent = 'Update Medication';

            // Store editing ID
            window.editingMedicationId = id;

            openModal('addMedModal');
        }

        async function updateMedication(event) {
            event.preventDefault();

            try {
                const id = window.editingMedicationId;
                const med = medications.find(m => m.id === id);

                if (!med) {
                    throw new Error('Medication not found');
                }

                med.name = sanitizeInput(document.getElementById('medName').value);
                med.dosage = sanitizeInput(document.getElementById('medDosage').value);
                med.time = document.getElementById('medTime').value;
                med.frequency = document.getElementById('medFrequency').value;
                med.updatedAt = new Date().toISOString();

                validateMedicationData(med);

                saveMedications();

                // Sync to ESP32
                try {
                    await esp32Request(`/api/medications/${id}`, 'PUT', med);
                } catch (error) {
                    console.warn('Failed to sync update to ESP32');
                }

                updateDashboard();
                updateAllMedications();
                closeModal('addMedModal');
                showAlert('Medication updated successfully!', 'success');

                // Reset modal
                delete window.editingMedicationId;
                resetMedicationModal();

            } catch (error) {
                showAlert(error.message, 'error');
            }
        }

        function resetMedicationModal() {
            const modal = document.getElementById('addMedModal');
            const title = modal.querySelector('.modal-title');
            const submitBtn = modal.querySelector('button[type="submit"]');

            title.textContent = 'Add New Medication';
            submitBtn.textContent = 'Add Medication';
        }

        // Confirm Medication Taken
        async function confirmMedication(id) {
            const med = medications.find(m => m.id === id);
            if (!med) return;

            try {
                med.taken = true;
                med.takenAt = new Date().toISOString();
                adherenceData.taken++;
                adherenceData.total++;
                adherenceData.streak++;

                saveMedications();

                // Sync to ESP32
                try {
                    await esp32Request('/api/confirm', 'POST', { medicationId: id, timestamp: med.takenAt });
                } catch (error) {
                    console.warn('Failed to sync confirmation to ESP32');
                }

                // Send WebSocket update
                if (websocket && websocket.readyState === WebSocket.OPEN) {
                    websocket.send(JSON.stringify({ type: 'medication_confirmed', id: id }));
                }

                // Clear reminder timeout
                if (reminderTimeouts[id]) {
                    clearTimeout(reminderTimeouts[id]);
                    delete reminderTimeouts[id];
                }

                updateDashboard();
                showAlert(`${med.name} marked as taken!`, 'success');
                speakText(`Great! ${med.name} confirmed.`);

            } catch (error) {
                showAlert('Failed to confirm medication', 'error');
            }
        }

        // Update Dashboard
        function updateDashboard() {
            const todayMeds = medications.filter(m => !m.taken).sort((a, b) => a.time.localeCompare(b.time));
            const adherence = adherenceData.total > 0 ? Math.round((adherenceData.taken / adherenceData.total) * 100) : 0;

            document.getElementById('todayAdherence').textContent = `${adherence}%`;
            document.getElementById('currentStreak').textContent = adherenceData.streak;

            const todayMedsContainer = document.getElementById('todayMedications');
            todayMedsContainer.innerHTML = todayMeds.length === 0
                ? '<p style="text-align: center; color: var(--gray-500); padding: 20px;">All medications taken today!</p>'
                : todayMeds.map(med => `
                    <div class="medication-item">
                        <div class="medication-info">
                            <div class="medication-name">${med.name}</div>
                            <div class="medication-time">Time: ${med.time}</div>
                            <div class="medication-dosage">Dosage: ${med.dosage}</div>
                        </div>
                        <div class="medication-actions">
                            <div class="status-indicator status-pending"></div>
                            <button class="confirm-btn" onclick="confirmMedication(${med.id})">Confirm</button>
                        </div>
                    </div>
                `).join('');

            if (todayMeds.length > 0) {
                const nextMed = todayMeds[0];
                document.getElementById('nextMedTime').textContent = nextMed.time;
                document.getElementById('nextMedName').textContent = nextMed.name;
            } else {
                document.getElementById('nextMedTime').textContent = '--:--';
                document.getElementById('nextMedName').textContent = 'All done!';
            }

            updateRecentActivity();
        }

        // Update All Medications Tab
        function updateAllMedications() {
            const allMedsContainer = document.getElementById('allMedications');
            const sortedMeds = medications.sort((a, b) => a.time.localeCompare(b.time));

            allMedsContainer.innerHTML = medications.length === 0
                ? '<p style="text-align: center; color: var(--gray-500); padding: 40px;">No medications added yet. Click "+ Add New" to get started.</p>'
                : sortedMeds.map(med => `
                    <div class="medication-item">
                        <div class="medication-info">
                            <div class="medication-name">${med.name}</div>
                            <div class="medication-time">Time: ${med.time} | Frequency: ${med.frequency}</div>
                            <div class="medication-dosage">Dosage: ${med.dosage}</div>
                        </div>
                        <div class="medication-actions" style="gap: 8px;">
                            <div class="status-indicator ${med.taken ? 'status-taken' : 'status-pending'}"></div>
                            <button class="confirm-btn" onclick="editMedication(${med.id})" style="background: var(--primary); font-size: 12px; padding: 8px 12px;">Edit</button>
                            <button class="confirm-btn" onclick="deleteMedication(${med.id})" style="background: var(--danger); font-size: 12px; padding: 8px 12px;">Delete</button>
                        </div>
                    </div>
                `).join('');
        }

        // Delete Medication
        async function deleteMedication(id) {
            if (!confirm('Are you sure you want to delete this medication?')) {
                return;
            }

            try {
                medications = medications.filter(m => m.id !== id);
                saveMedications();

                // Sync to ESP32
                try {
                    await esp32Request(`/api/medications/${id}`, 'DELETE');
                } catch (error) {
                    console.warn('Failed to sync deletion to ESP32');
                }

                updateDashboard();
                updateAllMedications();
                showAlert('Medication deleted', 'success');
            } catch (error) {
                showAlert('Failed to delete medication', 'error');
            }
        }

        // Update Recent Activity
        function updateRecentActivity() {
            const recentContainer = document.getElementById('recentActivity');
            const recentMeds = medications.filter(m => m.taken).slice(-5).reverse();

            recentContainer.innerHTML = recentMeds.length === 0
                ? '<p style="text-align: center; color: var(--gray-500); padding: 20px;">No recent activity</p>'
                : recentMeds.map(med => `
                    <div style="padding: 12px; background: var(--gray-50); border-radius: var(--radius); margin-bottom: 10px; border-left: 3px solid var(--success);">
                        <div style="font-weight: 600; color: var(--gray-900);">${med.name}</div>
                        <div style="font-size: 13px; color: var(--gray-600);">Taken at ${med.time}</div>
                    </div>
                `).join('');
        }

        // Update Weekly Schedule
        function updateWeeklySchedule() {
            const scheduleContainer = document.getElementById('weeklySchedule');
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

            scheduleContainer.innerHTML = days.map(day => `
                <div style="margin-bottom: 24px; padding: 16px; background: var(--gray-50); border-radius: var(--radius);">
                    <h3 style="margin: 0 0 12px 0; color: var(--primary); font-size: 18px;">${day}</h3>
                    ${medications.map(med => `
                        <div style="padding: 10px; background: #ffffff; border: 1px solid var(--gray-300); border-radius: var(--radius-sm); margin-bottom: 8px;">
                            <strong>${med.time}</strong> - ${med.name} (${med.dosage})
                        </div>
                    `).join('') || '<p style="color: var(--gray-500);">No medications scheduled</p>'}
                </div>
            `).join('');
        }

        // Update Analytics
        function updateAnalytics() {
            const canvas = document.getElementById('adherenceChart');
            const ctx = canvas.getContext('2d');

            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Simple bar chart
            const adherenceRate = adherenceData.total > 0 ? (adherenceData.taken / adherenceData.total) : 0;
            const barHeight = adherenceRate * 150;

            ctx.fillStyle = '#4f46e5';
            ctx.fillRect(50, 200 - barHeight, 80, barHeight);

            ctx.fillStyle = '#10b981';
            ctx.fillRect(150, 200 - (adherenceData.streak * 10), 80, adherenceData.streak * 10);

            ctx.fillStyle = '#333';
            ctx.font = '14px Arial';
            ctx.fillText('Adherence', 40, 220);
            ctx.fillText('Streak', 150, 220);
            ctx.fillText(`${Math.round(adherenceRate * 100)}%`, 60, 190 - barHeight);
            ctx.fillText(`${adherenceData.streak}d`, 170, 190 - (adherenceData.streak * 10));
        }

        // Improved Reminder System
        let reminderTimeouts = {};

        function startReminderSystem() {
            // Clear existing timeouts
            Object.values(reminderTimeouts).forEach(timeout => clearTimeout(timeout));
            reminderTimeouts = {};

            // Check reminders every minute (for accuracy)
            setInterval(scheduleNextReminders, 60000);

            // Initial schedule
            scheduleNextReminders();
        }

        function scheduleNextReminders() {
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();

            medications.forEach(med => {
                if (med.taken) return;

                const [hours, minutes] = med.time.split(':').map(Number);
                const medTime = hours * 60 + minutes;

                // Calculate time until reminder (in milliseconds)
                let timeUntil = (medTime - currentTime) * 60 * 1000;

                // If time has passed today, skip (will trigger tomorrow)
                if (timeUntil < 0) return;

                // Clear existing timeout for this medication
                if (reminderTimeouts[med.id]) {
                    clearTimeout(reminderTimeouts[med.id]);
                }

                // Schedule reminder
                reminderTimeouts[med.id] = setTimeout(() => {
                    if (!med.taken) {
                        showReminder(med);
                        scheduleEscalation(med);
                    }
                }, timeUntil);

                // Schedule pre-reminder (15 minutes before)
                if (timeUntil > 15 * 60 * 1000) {
                    setTimeout(() => {
                        if (!med.taken) {
                            showAlert(`Reminder: ${med.name} in 15 minutes`, 'info');
                        }
                    }, timeUntil - 15 * 60 * 1000);
                }
            });
        }

        function scheduleEscalation(med) {
            // Repeat reminder every 5 minutes if not confirmed
            const escalationInterval = setInterval(() => {
                if (med.taken) {
                    clearInterval(escalationInterval);
                } else {
                    showReminder(med);
                    playReminderSound();
                }
            }, 5 * 60 * 1000); // 5 minutes

            // Clear after 30 minutes (6 repetitions)
            setTimeout(() => clearInterval(escalationInterval), 30 * 60 * 1000);
        }

        function showReminder(med) {
            showAlert(`Time to take ${med.name} (${med.dosage})`, 'warning');
            speakText(`Time to take your ${med.name}`);
            playReminderSound();
        }

        function playReminderSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.frequency.value = 800;
                oscillator.type = 'square';
                gainNode.gain.value = 0.3;

                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (error) {
                console.log('Audio not supported');
            }
        }

        // Text-to-Speech
        function speakText(text) {
            if (!('speechSynthesis' in window)) {
                console.log('Text-to-speech not supported in this browser');
                return;
            }

            try {
                speechSynthesis.cancel(); // Cancel any ongoing speech
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.9;
                utterance.pitch = 1.0;
                utterance.volume = 1.0;
                utterance.lang = 'en-US';

                utterance.onerror = (event) => {
                    console.error('Speech synthesis error:', event.error);
                };

                utterance.onend = () => {
                    console.log('Speech finished');
                };

                speechSynthesis.speak(utterance);
            } catch (error) {
                console.error('Failed to speak text:', error);
            }
        }

        // Voice Assistant
        function startVoiceAssistant() {
            // Check if running on localhost or HTTPS
            const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';

            if (!isSecure) {
                showAlert('⚠️ Microphone requires HTTPS or localhost. Please run: python -m http.server 8000 or use a local server.', 'error');
                return;
            }

            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                showAlert('❌ Voice recognition not supported in this browser. Try Chrome or Edge.', 'error');
                return;
            }

            try {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                const recognition = new SpeechRecognition();
                recognition.lang = 'en-US';
                recognition.continuous = false;
                recognition.interimResults = false;

                recognition.onstart = () => showAlert('🎤 Listening... Speak now!', 'info');

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    showAlert(`You said: "${transcript}"`, 'success');
                    processChatMessage(transcript);
                };

                recognition.onerror = (event) => {
                    let errorMsg = '❌ Voice recognition error: ';
                    if (event.error === 'not-allowed') {
                        errorMsg += 'Please allow microphone permissions in your browser.';
                    } else if (event.error === 'no-speech') {
                        errorMsg += 'No speech detected. Please try again.';
                    } else {
                        errorMsg += event.error;
                    }
                    showAlert(errorMsg, 'error');
                };

                recognition.onend = () => {
                    console.log('Voice recognition ended');
                };

                recognition.start();
            } catch (error) {
                showAlert('❌ Failed to start voice recognition: ' + error.message, 'error');
            }
        }

        // Chat System
        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }

        function sendChatMessage() {
            const input = document.getElementById('chatInput');

            if (!input) {
                console.error('Chat input element not found');
                showAlert('❌ Chat input not found', 'error');
                return;
            }

            const message = input.value.trim();

            if (!message) {
                showAlert('⚠️ Please type a message', 'warning');
                return;
            }

            console.log('Sending chat message:', message);
            processChatMessage(message);
            input.value = '';
        }

        async function processChatMessage(message) {
            const chatMessages = document.getElementById('chatMessages');

            chatMessages.innerHTML += `
                <div style="padding: 12px; background: var(--primary); color: white; border-radius: var(--radius); margin-bottom: 12px; text-align: right;">
                    <strong>You:</strong> ${message}
                </div>
            `;

            // Check API key
            if (!geminiApiKey) {
                chatMessages.innerHTML += `
                    <div style="padding: 12px; background: #ffffff; border: 1px solid var(--danger); border-radius: var(--radius); margin-bottom: 12px;">
                        <strong>AI:</strong> Please configure your Gemini API key in Settings to use the AI assistant.
                    </div>
                `;
                chatMessages.scrollTop = chatMessages.scrollHeight;
                return;
            }

            // Show thinking indicator
            const thinkingId = 'thinking-' + Date.now();
            chatMessages.innerHTML += `
                <div id="${thinkingId}" style="padding: 12px; background: #ffffff; border: 1px solid var(--gray-300); border-radius: var(--radius); margin-bottom: 12px;">
                    <strong>AI:</strong> <em>Thinking...</em>
                </div>
            `;
            chatMessages.scrollTop = chatMessages.scrollHeight;

            try {
                console.log('Sending request to Gemini API...');

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${geminiApiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: `You are a helpful medical assistant specializing in elderly care and medication management. Current medications: ${medications.map(m => m.name).join(', ') || 'None'}. Answer this question: ${message}` }]
                        }]
                    })
                });

                // Remove thinking indicator
                const thinkingElement = document.getElementById(thinkingId);
                if (thinkingElement) thinkingElement.remove();

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`API Error ${response.status}: ${errorData.error?.message || 'Unknown error'}`);
                }

                const data = await response.json();
                console.log('Received response from Gemini API');

                if (!data.candidates || !data.candidates[0]) {
                    throw new Error('Invalid API response - no candidates');
                }

                const answer = data.candidates[0].content.parts[0].text;
                const chatMessageId = 'chat-msg-' + Date.now();

                // Format the answer with HTML
                const formattedAnswer = answer
                    .replace(/\n/g, '<br>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/• /g, '<br>• ');

                chatMessages.innerHTML += `
                    <div id="${chatMessageId}" style="padding: 12px; background: #ffffff; border: 1px solid var(--gray-300); border-radius: var(--radius); margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; gap: 12px;">
                            <div style="flex: 1;">
                                <strong>AI:</strong> <span class="message-text">${formattedAnswer}</span>
                            </div>
                            <button onclick="copyMessage('${chatMessageId}')" style="background: none; border: none; color: var(--primary); cursor: pointer; padding: 4px 8px; font-size: 12px; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='var(--gray-100)'" onmouseout="this.style.background='none'" title="Copy message">
                                📋 Copy
                            </button>
                        </div>
                    </div>
                `;

                chatMessages.scrollTop = chatMessages.scrollHeight;

                // Speak response
                speakText(answer);
            } catch (error) {
                console.error('Chat error:', error);

                // Remove thinking indicator
                const thinkingElement = document.getElementById(thinkingId);
                if (thinkingElement) thinkingElement.remove();

                chatMessages.innerHTML += `
                    <div style="padding: 12px; background: #ffffff; border: 1px solid var(--danger); border-radius: var(--radius); margin-bottom: 12px;">
                        <strong>Error:</strong> ${error.message}
                    </div>
                `;
                chatMessages.scrollTop = chatMessages.scrollHeight;
                showAlert('❌ AI Error: ' + error.message, 'error');
            }
        }

        // Camera & Document Scanning
        async function openCamera(mode = 'document') {
            // Check if running on localhost or HTTPS
            const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';

            if (!isSecure) {
                showAlert('⚠️ Camera requires HTTPS or localhost. Please run: python -m http.server 8000 or use a local server.', 'error');
                return;
            }

            // Check if mediaDevices is available
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showAlert('❌ Camera not supported in this browser. Try Chrome or Edge.', 'error');
                return;
            }

            openModal('scanModal');

            // Update modal title based on mode
            const modalTitle = document.querySelector('#scanModal .modal-title');
            modalTitle.textContent = mode === 'pill' ? 'Identify Pill' : 'Scan Document';

            // Store scan mode
            window.currentScanMode = mode;

            // Show loading on video element
            const video = document.getElementById('scanVideo');
            video.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            video.style.display = 'flex';
            video.style.alignItems = 'center';
            video.style.justifyContent = 'center';

            try {
                showAlert('📷 Opening camera...', 'info');

                // Use simpler constraints for faster loading
                const constraints = {
                    video: {
                        facingMode: currentCamera,
                        width: { ideal: 1280, max: 1920 },
                        height: { ideal: 720, max: 1080 }
                    }
                };

                // Add timeout to prevent infinite waiting
                const streamPromise = navigator.mediaDevices.getUserMedia(constraints);
                const timeoutPromise = new Promise((_, reject) =>
                    setTimeout(() => reject(new Error('Camera timeout')), 10000)
                );

                currentStream = await Promise.race([streamPromise, timeoutPromise]);

                video.srcObject = currentStream;
                video.style.background = 'none';

                // Wait for video to actually start playing
                await new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        video.play();
                        resolve();
                    };
                });

                showAlert('✅ Camera ready!', 'success');
            } catch (error) {
                console.error('Camera error:', error);
                video.style.background = 'none';

                let errorMsg = '❌ Camera access failed. ';

                if (error.message === 'Camera timeout') {
                    errorMsg += 'Camera took too long to respond. Please try again.';
                } else if (error.name === 'NotAllowedError') {
                    errorMsg += 'Please allow camera permissions in your browser settings.';
                } else if (error.name === 'NotFoundError') {
                    errorMsg += 'No camera found on this device.';
                } else if (error.name === 'NotReadableError') {
                    errorMsg += 'Camera is already in use by another application.';
                } else {
                    errorMsg += error.message;
                }

                showAlert(errorMsg, 'error');
                closeModal('scanModal');
            }
        }

        function identifyPill() {
            openCamera('pill');
        }

        async function switchCamera() {
            currentCamera = currentCamera === 'environment' ? 'user' : 'environment';

            // Stop current stream before switching
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }

            // Re-open camera with new facing mode
            const mode = window.currentScanMode || 'document';
            const video = document.getElementById('scanVideo');

            try {
                showAlert('🔄 Switching camera...', 'info');

                const constraints = {
                    video: {
                        facingMode: currentCamera,
                        width: { ideal: 1280, max: 1920 },
                        height: { ideal: 720, max: 1080 }
                    }
                };

                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = currentStream;

                showAlert('✅ Camera switched!', 'success');
            } catch (error) {
                console.error('Camera switch error:', error);
                showAlert('❌ Failed to switch camera', 'error');
            }
        }

        function captureDocument() {
            const video = document.getElementById('scanVideo');
            const canvas = document.getElementById('scanCanvas');

            // Validate video element
            if (!video) {
                showAlert('❌ Video element not found', 'error');
                return;
            }

            if (!video.srcObject) {
                showAlert('⚠️ Camera not started. Please allow camera access.', 'warning');
                return;
            }

            if (video.videoWidth === 0 || video.videoHeight === 0) {
                showAlert('⚠️ Camera not ready. Please wait a moment...', 'warning');
                return;
            }

            try {
                const ctx = canvas.getContext('2d');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0);

                showAlert('📸 Photo captured! Analyzing...', 'info');

                const mode = window.currentScanMode || 'document';

                canvas.toBlob(blob => {
                    if (!blob) {
                        showAlert('❌ Failed to capture image', 'error');
                        return;
                    }

                    console.log(`Captured ${mode} image, size: ${blob.size} bytes`);

                    if (mode === 'pill') {
                        analyzePill(blob);
                    } else {
                        analyzeDocument(blob);
                    }
                }, 'image/jpeg', 0.95);
            } catch (error) {
                console.error('Capture error:', error);
                showAlert('❌ Failed to capture photo: ' + error.message, 'error');
            }
        }

        async function analyzePill(imageBlob) {
            // Check API key first
            if (!geminiApiKey) {
                showAlert('Please configure your Gemini API key in Settings', 'error');
                return;
            }

            document.getElementById('scanLoading').classList.add('active');

            try {
                const base64 = await blobToBase64(imageBlob);
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: 'You are a medication identification expert. Analyze this pill/medication image and provide: 1) Possible medication name, 2) Common uses, 3) Typical dosage, 4) Important warnings. Be clear if you cannot identify it.' },
                                { inline_data: { mime_type: 'image/jpeg', data: base64 } }
                            ]
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const data = await response.json();

                if (!data.candidates || !data.candidates[0]) {
                    throw new Error('No analysis result received');
                }

                const result = data.candidates[0].content.parts[0].text;

                document.getElementById('scanResult').innerHTML = `
                    <div style="padding: 16px; background: #ffffff; border: 1px solid var(--success); border-radius: var(--radius); margin-top: 16px;">
                        <strong style="color: var(--success);">✓ Pill Identification:</strong><br><br>
                        <div style="white-space: pre-wrap;">${result}</div>
                        <div style="margin-top: 12px; padding: 10px; background: var(--warning); color: white; border-radius: var(--radius-sm); font-size: 13px;">
                            ⚠️ Warning: Always consult with a healthcare professional before taking any medication.
                        </div>
                    </div>
                `;

                showAlert('Pill identified!', 'success');
            } catch (error) {
                console.error('Pill identification error:', error);
                document.getElementById('scanResult').innerHTML = `
                    <div style="padding: 16px; background: #ffffff; border: 1px solid var(--danger); border-radius: var(--radius); margin-top: 16px;">
                        <strong style="color: var(--danger);">✕ Error:</strong><br>
                        Failed to identify pill. Please ensure the image is clear and try again.
                    </div>
                `;
                showAlert('Failed to identify pill', 'error');
            } finally {
                document.getElementById('scanLoading').classList.remove('active');
            }
        }

        async function analyzeDocument(imageBlob) {
            // Check API key first
            if (!geminiApiKey) {
                showAlert('Please configure your Gemini API key in Settings', 'error');
                return;
            }

            document.getElementById('scanLoading').classList.add('active');

            try {
                const base64 = await blobToBase64(imageBlob);
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: 'You are a medical document analyzer. Extract medication information from this prescription or medical document. List: medication names, dosages, frequency, and times to take. Format clearly.' },
                                { inline_data: { mime_type: 'image/jpeg', data: base64 } }
                            ]
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const data = await response.json();

                if (!data.candidates || !data.candidates[0]) {
                    throw new Error('No analysis result received');
                }

                const result = data.candidates[0].content.parts[0].text;

                document.getElementById('scanResult').innerHTML = `
                    <div style="padding: 16px; background: #ffffff; border: 1px solid var(--success); border-radius: var(--radius); margin-top: 16px;">
                        <strong style="color: var(--success);">✓ Analysis Result:</strong><br><br>
                        <div style="white-space: pre-wrap;">${result}</div>
                        <button class="action-btn" style="margin-top: 12px; width: 100%;" onclick="addMedicationFromScan()">Add to Schedule</button>
                    </div>
                `;

                showAlert('Document analyzed successfully!', 'success');
            } catch (error) {
                console.error('Scan error:', error);
                document.getElementById('scanResult').innerHTML = `
                    <div style="padding: 16px; background: #ffffff; border: 1px solid var(--danger); border-radius: var(--radius); margin-top: 16px;">
                        <strong style="color: var(--danger);">✕ Error:</strong><br>
                        Failed to analyze document. Please check your API key and try again.
                    </div>
                `;
                showAlert('Failed to analyze document', 'error');
            } finally {
                document.getElementById('scanLoading').classList.remove('active');
            }
        }

        function addMedicationFromScan() {
            showAlert('Please manually add medications from the analysis above', 'info');
            closeScanner();
            openModal('addMedModal');
        }

        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        function closeScanner() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            closeModal('scanModal');
        }

        // Emergency
        function handleEmergency() {
            const contact = localStorage.getItem('emergencyContact') || '';

            showAlert('🚨 EMERGENCY ALERT ACTIVATED!', 'error');

            // Show emergency options
            const options = contact
                ? `EMERGENCY OPTIONS:\n\n1. Call Emergency Contact: ${contact}\n2. Call Emergency Services: 10177\n3. Video Call Emergency Contact\n\nSelect option (1-3) or Cancel:`
                : `EMERGENCY OPTIONS:\n\n1. Call Emergency Services: 10177\n2. Set Emergency Contact first\n\nPress OK to call 10177 or Cancel:`;

            if (contact) {
                const choice = prompt(options);
                if (choice === '1') {
                    startPhoneCall();
                } else if (choice === '2') {
                    emergencyCall();
                } else if (choice === '3') {
                    startVideoCall();
                }
            } else {
                const confirmed = confirm(options);
                if (confirmed) {
                    emergencyCall();
                }
            }
        }

        // Settings
        function updateVolumeDisplay(value) {
            document.getElementById('volumeDisplay').textContent = `${value}%`;
        }

        // Settings - ESP32 Enable Toggle
        function initESP32Toggle() {
            const esp32EnableCheckbox = document.getElementById('esp32Enable');
            const esp32UrlGroup = document.getElementById('esp32UrlGroup');

            if (esp32EnableCheckbox) {
                esp32EnableCheckbox.addEventListener('change', function() {
                    esp32UrlGroup.style.display = this.checked ? 'block' : 'none';
                });
            }
        }

        async function saveSettings() {
            try {
                const apiKey = sanitizeInput(document.getElementById('apiKey').value);
                const patientName = sanitizeInput(document.getElementById('patientName').value);
                const emergencyContact = sanitizeInput(document.getElementById('emergencyContact').value);
                const esp32Enable = document.getElementById('esp32Enable').checked;
                const esp32Url = sanitizeInput(document.getElementById('esp32Url').value);
                const volume = document.getElementById('reminderVolume').value;

                if (apiKey) {
                    geminiApiKey = apiKey;
                    localStorage.setItem('geminiApiKey', apiKey);
                }
                if (patientName) localStorage.setItem('patientName', patientName);
                if (emergencyContact) localStorage.setItem('emergencyContact', emergencyContact);

                // ESP32 settings
                esp32Enabled = esp32Enable;
                localStorage.setItem('esp32Enabled', esp32Enable);

                if (esp32Enable && esp32Url) {
                    // Validate URL format
                    if (!esp32Url.startsWith('http://') && !esp32Url.startsWith('https://')) {
                        throw new Error('ESP32 URL must start with http:// or https://');
                    }
                    esp32BaseUrl = esp32Url;
                    localStorage.setItem('esp32BaseUrl', esp32Url);

                    // Try to connect
                    reconnectAttempts = 0; // Reset attempts
                    await connectToESP32();
                    initWebSocket();
                } else {
                    esp32BaseUrl = '';
                    esp32Connected = false;
                    document.getElementById('deviceStatus').textContent = 'Standalone';
                    document.getElementById('deviceStatus').style.color = 'var(--gray-500)';
                    console.log('💡 ESP32 disabled - running in standalone mode');
                }

                localStorage.setItem('reminderVolume', volume);

                closeModal('settingsModal');
                showAlert('Settings saved successfully!', 'success');
            } catch (error) {
                showAlert(error.message, 'error');
            }
        }

        function loadSettings() {
            const savedApiKey = localStorage.getItem('geminiApiKey');
            const savedPatientName = localStorage.getItem('patientName');
            const savedContact = localStorage.getItem('emergencyContact');
            const savedEsp32Enabled = localStorage.getItem('esp32Enabled') === 'true';
            const savedUrl = localStorage.getItem('esp32BaseUrl');
            const savedVolume = localStorage.getItem('reminderVolume');

            // Use saved API key or save default if not present
            if (savedApiKey) {
                geminiApiKey = savedApiKey;
            } else if (geminiApiKey) {
                // Save default API key to localStorage
                localStorage.setItem('geminiApiKey', geminiApiKey);
            }

            const apiKeyInput = document.getElementById('apiKey');
            if (apiKeyInput) apiKeyInput.value = geminiApiKey;
            if (savedPatientName) {
                const nameInput = document.getElementById('patientName');
                if (nameInput) nameInput.value = savedPatientName;
            }
            if (savedContact) {
                const contactInput = document.getElementById('emergencyContact');
                if (contactInput) contactInput.value = savedContact;
            }

            // Load ESP32 settings
            esp32Enabled = savedEsp32Enabled;
            const esp32EnableCheckbox = document.getElementById('esp32Enable');
            const esp32UrlGroup = document.getElementById('esp32UrlGroup');

            if (esp32EnableCheckbox) {
                esp32EnableCheckbox.checked = savedEsp32Enabled;
                if (esp32UrlGroup) {
                    esp32UrlGroup.style.display = savedEsp32Enabled ? 'block' : 'none';
                }
            }

            if (savedUrl) {
                esp32BaseUrl = savedUrl;
                const urlInput = document.getElementById('esp32Url');
                if (urlInput) urlInput.value = savedUrl;
            }

            if (savedVolume) {
                const volumeInput = document.getElementById('reminderVolume');
                const volumeDisplay = document.getElementById('volumeDisplay');
                if (volumeInput) volumeInput.value = savedVolume;
                if (volumeDisplay) volumeDisplay.textContent = `${savedVolume}%`;
            }
        }

        // Data Persistence
        function saveMedications() {
            localStorage.setItem('medications', JSON.stringify(medications));
            localStorage.setItem('adherenceData', JSON.stringify(adherenceData));
        }

        function loadMedications() {
            const savedMeds = localStorage.getItem('medications');
            const savedAdherence = localStorage.getItem('adherenceData');

            if (savedMeds) medications = JSON.parse(savedMeds);
            if (savedAdherence) adherenceData = JSON.parse(savedAdherence);
        }

        // Removed old fake connection check - now using real ESP32 connection

        // Export Schedule
        function exportSchedule() {
            const data = medications.map(m => `${m.time},${m.name},${m.dosage}`).join('\n');
            const blob = new Blob([data], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'medication_schedule.csv';
            a.click();
            showAlert('Schedule exported!', 'success');
        }

        function downloadReport() {
            showAlert('Generating report...', 'info');
            setTimeout(() => showAlert('Report downloaded!', 'success'), 2000);
        }

        function viewSchedule() {
            switchTab('schedule');
        }

        console.log('✅ MediCare Assistant initialized successfully');

        // Contact Form Handling
        document.addEventListener('DOMContentLoaded', function() {
            const contactForm = document.getElementById('contactForm');
            if (contactForm) {
                contactForm.addEventListener('submit', handleContactSubmit);
            }
        });

        async function handleContactSubmit(event) {
            event.preventDefault();

            const form = event.target;
            const submitBtn = document.getElementById('submitContactBtn');
            const formContent = form.parentElement.querySelector('form');
            const successDiv = document.getElementById('contactSuccess');

            // Add timestamp
            document.getElementById('contactTimestamp').value = new Date().toISOString();

            // Disable submit button
            submitBtn.disabled = true;
            submitBtn.textContent = 'Sending...';

            try {
                const formData = new FormData(form);

                const response = await fetch('https://formspree.io/f/xrbygvga', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (response.ok) {
                    // Hide form, show success message
                    formContent.style.display = 'none';
                    successDiv.style.display = 'block';

                    // Reset form
                    form.reset();

                    // Close modal after 3 seconds
                    setTimeout(() => {
                        closeModal('contactModal');
                        formContent.style.display = 'block';
                        successDiv.style.display = 'none';
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Send Message';
                    }, 3000);

                    showAlert('Message sent successfully!', 'success');
                } else {
                    throw new Error('Failed to send message');
                }
            } catch (error) {
                console.error('Contact form error:', error);
                showAlert('Failed to send message. Please try again.', 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Send Message';
            }
        }

        // Chatbot Functions
        function openChatbot() {
            // Stop all other audio/recognition first
            stopAllAudioAndRecognition();

            // End video call if active
            if (isInVideoCall) {
                endVideoCall();
            }

            // End phone call if active
            if (isInCall) {
                endCall();
            }

            openModal('chatbotModal');
            document.getElementById('chatbotInput').focus();
        }

        function closeChatbot() {
            // Stop chatbot recognition specifically
            if (chatbotRecognition) {
                try {
                    chatbotRecognition.stop();
                    chatbotRecognition = null;
                } catch (e) {
                    console.log('Error stopping chatbot recognition:', e);
                }
            }
            isChatbotListening = false;

            // Stop speech synthesis
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
            }

            closeModal('chatbotModal');
        }

        function handleChatbotKeyPress(event) {
            if (event.key === 'Enter') {
                sendChatbotMessage();
            }
        }

        function sendChatbotMessage() {
            const input = document.getElementById('chatbotInput');

            if (!input) {
                console.error('Chatbot input element not found');
                showAlert('❌ Chatbot input not found', 'error');
                return;
            }

            const message = input.value.trim();

            if (!message) {
                showAlert('⚠️ Please type a message', 'warning');
                return;
            }

            console.log('Sending chatbot message:', message);
            processChatbotMessage(message);
            input.value = '';
        }

        async function processChatbotMessage(message) {
            const chatMessages = document.getElementById('chatbotMessages');

            if (!chatMessages) {
                console.error('Chatbot messages element not found');
                showAlert('❌ Chatbot messages area not found', 'error');
                return;
            }

            // Sanitize message for HTML display
            const sanitizedMessage = message.replace(/</g, '&lt;').replace(/>/g, '&gt;');

            chatMessages.innerHTML += `
                <div style="padding: 12px; background: var(--primary); color: white; border-radius: var(--radius); margin-bottom: 12px; text-align: right;">
                    <strong>You:</strong> ${sanitizedMessage}
                </div>
            `;
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // Check API key
            if (!geminiApiKey) {
                chatMessages.innerHTML += `
                    <div style="padding: 12px; background: #ffffff; border: 1px solid var(--danger); border-radius: var(--radius); margin-bottom: 12px;">
                        <strong>AI:</strong> Please configure your Gemini API key in Settings to use the AI assistant.
                    </div>
                `;
                chatMessages.scrollTop = chatMessages.scrollHeight;
                return;
            }

            // Show thinking indicator
            const thinkingId = 'thinking-' + Date.now();
            chatMessages.innerHTML += `
                <div id="${thinkingId}" style="padding: 12px; background: #ffffff; border: 1px solid var(--gray-300); border-radius: var(--radius); margin-bottom: 12px;">
                    <strong>AI:</strong> <em>Thinking...</em>
                </div>
            `;
            chatMessages.scrollTop = chatMessages.scrollHeight;

            try {
                console.log('Sending request to Gemini API...');

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${geminiApiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: `You are a helpful medical assistant for elderly care. Current medications: ${medications.map(m => m.name).join(', ') || 'None'}.

IMPORTANT INSTRUCTIONS:
- Keep responses SHORT (2-3 sentences maximum)
- Use simple, clear language
- Use bullet points (•) for lists
- Use line breaks for readability
- Be direct and helpful
- Avoid medical jargon

Question: ${message}` }]
                        }]
                    })
                });

                // Remove thinking indicator
                const thinkingElement = document.getElementById(thinkingId);
                if (thinkingElement) thinkingElement.remove();

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`API Error ${response.status}: ${errorData.error?.message || 'Unknown error'}`);
                }

                const data = await response.json();
                console.log('Received response from Gemini API');

                if (!data.candidates || !data.candidates[0]) {
                    throw new Error('Invalid API response - no candidates');
                }

                const answer = data.candidates[0].content.parts[0].text;
                const messageId = 'msg-' + Date.now();

                // Format the answer with HTML
                const formattedAnswer = answer
                    .replace(/\n/g, '<br>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/• /g, '<br>• ');

                chatMessages.innerHTML += `
                    <div id="${messageId}" style="padding: 12px; background: #ffffff; border: 1px solid var(--gray-300); border-radius: var(--radius); margin-bottom: 12px; position: relative;">
                        <div style="display: flex; justify-content: space-between; align-items: start; gap: 12px;">
                            <div style="flex: 1;">
                                <strong>AI:</strong> <span class="message-text">${formattedAnswer}</span>
                            </div>
                            <button onclick="copyMessage('${messageId}')" style="background: none; border: none; color: var(--primary); cursor: pointer; padding: 4px 8px; font-size: 12px; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='var(--gray-100)'" onmouseout="this.style.background='none'" title="Copy message">
                                📋 Copy
                            </button>
                        </div>
                    </div>
                `;

                chatMessages.scrollTop = chatMessages.scrollHeight;

                // Speak response
                speakText(answer);
            } catch (error) {
                console.error('Chatbot error:', error);

                // Remove thinking indicator
                const thinkingElement = document.getElementById(thinkingId);
                if (thinkingElement) thinkingElement.remove();

                chatMessages.innerHTML += `
                    <div style="padding: 12px; background: #ffffff; border: 1px solid var(--danger); border-radius: var(--radius); margin-bottom: 12px;">
                        <strong>Error:</strong> ${error.message}
                    </div>
                `;
                chatMessages.scrollTop = chatMessages.scrollHeight;
                showAlert('❌ AI Error: ' + error.message, 'error');
            }
        }

        function startChatbotVoice() {
            // Prevent multiple simultaneous recognition sessions
            if (isChatbotListening) {
                console.log('Voice recognition already active, ignoring duplicate request');
                showAlert('⚠️ Already listening...', 'warning');
                return;
            }

            // Check if running on localhost or HTTPS
            const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';

            if (!isSecure) {
                showAlert('⚠️ Microphone requires HTTPS or localhost. Please run on a local server.', 'error');
                return;
            }

            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                showAlert('❌ Voice recognition not supported in this browser. Try Chrome or Edge.', 'error');
                return;
            }

            try {
                // Stop any existing recognition first
                if (chatbotRecognition) {
                    try {
                        chatbotRecognition.stop();
                    } catch (e) {}
                    chatbotRecognition = null;
                }

                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                chatbotRecognition = new SpeechRecognition();
                chatbotRecognition.lang = 'en-US';
                chatbotRecognition.continuous = false;
                chatbotRecognition.interimResults = false;
                chatbotRecognition.maxAlternatives = 1;

                chatbotRecognition.onstart = () => {
                    isChatbotListening = true;
                    console.log('Chatbot voice recognition started');
                    showAlert('🎤 Listening... Speak now!', 'info');
                };

                chatbotRecognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    console.log('Chatbot transcript:', transcript);
                    showAlert(`You said: "${transcript}"`, 'success');

                    // Put the transcript in the input field
                    const input = document.getElementById('chatbotInput');
                    if (input) {
                        input.value = transcript;
                    }

                    // Automatically send the message
                    setTimeout(() => {
                        processChatbotMessage(transcript);
                    }, 500);
                };

                chatbotRecognition.onerror = (event) => {
                    console.error('Chatbot voice recognition error:', event);
                    isChatbotListening = false;
                    chatbotRecognition = null;

                    // Don't show error for 'aborted' - that's intentional (happens when closing chatbot)
                    if (event.error === 'aborted') {
                        console.log('Voice recognition aborted (normal when closing chatbot)');
                        return;
                    }

                    let errorMsg = '❌ Voice recognition error: ';
                    if (event.error === 'not-allowed' || event.error === 'permission-denied') {
                        errorMsg += 'Please allow microphone permissions in your browser settings.';
                    } else if (event.error === 'no-speech') {
                        errorMsg += 'No speech detected. Please try again.';
                    } else if (event.error === 'audio-capture') {
                        errorMsg += 'No microphone found. Please check your device.';
                    } else if (event.error === 'network') {
                        errorMsg += 'Network error. Please check your connection.';
                    } else {
                        errorMsg += event.error;
                    }
                    showAlert(errorMsg, 'error');
                };

                chatbotRecognition.onend = () => {
                    console.log('Chatbot voice recognition ended');
                    isChatbotListening = false;
                    chatbotRecognition = null;
                };

                chatbotRecognition.start();
            } catch (error) {
                console.error('Failed to start chatbot voice recognition:', error);
                isChatbotListening = false;
                showAlert('❌ Failed to start voice recognition: ' + error.message, 'error');
            }
        }

        // Open chatbot and immediately start voice input
        function openChatbotWithVoice() {
            openChatbot();
            // Wait a moment for modal to open, then start voice
            setTimeout(() => {
                startChatbotVoice();
            }, 300);
        }

        // Copy message to clipboard
        function copyMessage(messageId) {
            const messageElement = document.getElementById(messageId);
            if (!messageElement) {
                showAlert('❌ Message not found', 'error');
                return;
            }

            const textElement = messageElement.querySelector('.message-text');
            const text = textElement ? textElement.textContent : messageElement.textContent;

            // Remove "AI:" prefix if present
            const cleanText = text.replace(/^AI:\s*/i, '').trim();

            navigator.clipboard.writeText(cleanText).then(() => {
                showAlert('✅ Copied to clipboard!', 'success');

                // Visual feedback - change button text briefly
                const button = messageElement.querySelector('button');
                if (button) {
                    const originalText = button.innerHTML;
                    button.innerHTML = '✓ Copied';
                    setTimeout(() => {
                        button.innerHTML = originalText;
                    }, 2000);
                }
            }).catch(error => {
                console.error('Copy failed:', error);
                showAlert('❌ Failed to copy', 'error');
            });
        }

        // AI Video Call - Global Variables
        let isInVideoCall = false;
        let videoStream = null;
        let videoCallDuration = 0;
        let videoDurationInterval = null;
        let videoRecognition = null;
        let isVideoMuted = false;
        let isVideoCameraOff = false;

        // AI Phone Call - Global Variables
        let isInCall = false;
        let callDuration = 0;
        let callDurationInterval = null;
        let callRecognition = null;
        let isCallMuted = false;

        // Chatbot Voice Recognition - Global Variables
        let chatbotRecognition = null;
        let isChatbotListening = false;

        // Global cleanup function - stops all audio and recognition
        function stopAllAudioAndRecognition() {
            // Stop speech synthesis
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
            }

            // Hide all indicators
            document.getElementById('listeningIndicator').style.display = 'none';
            document.getElementById('speakingIndicator').style.display = 'none';

            // Stop video call recognition
            if (videoRecognition) {
                try {
                    videoRecognition.stop();
                } catch (e) {}
            }

            // Stop phone call recognition
            if (callRecognition) {
                try {
                    callRecognition.stop();
                } catch (e) {}
            }

            // Stop chatbot recognition
            if (chatbotRecognition) {
                try {
                    chatbotRecognition.stop();
                    chatbotRecognition = null;
                } catch (e) {}
            }
            isChatbotListening = false;

            console.log('All audio and recognition stopped');
        }

        // Start AI Video Call
        async function startVideoCall() {
            // Stop all other audio/recognition first
            stopAllAudioAndRecognition();

            // End phone call if active
            if (isInCall) {
                endCall();
            }

            // Close chatbot if open
            closeChatbot();

            if (!geminiApiKey) {
                showAlert('⚠️ Please set Gemini API key in Settings first', 'warning');
                return;
            }

            const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
            if (!isSecure) {
                showAlert('⚠️ Video call requires HTTPS or localhost', 'error');
                return;
            }

            try {
                // Request camera access
                videoStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user' },
                    audio: true
                });

                const videoElement = document.getElementById('userVideo');
                videoElement.srcObject = videoStream;

                // Show video call interface
                document.getElementById('videoCallInterface').style.display = 'flex';
                document.getElementById('videoCallStatus').textContent = 'Connected to AI Health Assistant';

                isInVideoCall = true;
                videoCallDuration = 0;

                // Start duration timer
                videoDurationInterval = setInterval(() => {
                    videoCallDuration++;
                    const mins = Math.floor(videoCallDuration / 60).toString().padStart(2, '0');
                    const secs = (videoCallDuration % 60).toString().padStart(2, '0');
                    document.getElementById('videoCallDuration').textContent = `${mins}:${secs}`;
                }, 1000);

                // Start voice recognition
                startVideoVoiceRecognition();

                showAlert('✅ Video call started!', 'success');
            } catch (error) {
                console.error('Video call error:', error);
                showAlert('❌ Failed to start video call: ' + error.message, 'error');
            }
        }

        // End Video Call
        function endVideoCall() {
            // Stop all audio and recognition
            stopAllAudioAndRecognition();

            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }

            if (videoDurationInterval) {
                clearInterval(videoDurationInterval);
                videoDurationInterval = null;
            }

            if (videoRecognition) {
                try { videoRecognition.stop(); } catch (e) {}
                videoRecognition = null;
            }

            document.getElementById('videoCallInterface').style.display = 'none';
            isInVideoCall = false;
            isVideoMuted = false;
            isVideoCameraOff = false;

            document.getElementById('videoMuteBtn').classList.remove('muted');
            document.getElementById('videoCameraBtn').classList.remove('off');

            showAlert('📞 Video call ended', 'info');
        }

        // Start AI Phone Call
        function startPhoneCall() {
            // Stop all other audio/recognition first
            stopAllAudioAndRecognition();

            // End video call if active
            if (isInVideoCall) {
                endVideoCall();
            }

            // Close chatbot if open
            closeChatbot();

            if (!geminiApiKey) {
                showAlert('⚠️ Please set Gemini API key in Settings first', 'warning');
                return;
            }

            const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
            if (!isSecure) {
                showAlert('⚠️ Phone call requires HTTPS or localhost', 'error');
                return;
            }

            // Show call interface
            document.getElementById('callInterface').style.display = 'flex';
            document.getElementById('callStatus').textContent = 'Connected to AI Health Assistant';

            isInCall = true;
            callDuration = 0;

            // Start duration timer
            callDurationInterval = setInterval(() => {
                callDuration++;
                const mins = Math.floor(callDuration / 60).toString().padStart(2, '0');
                const secs = (callDuration % 60).toString().padStart(2, '0');
                document.getElementById('callDuration').textContent = `${mins}:${secs}`;
            }, 1000);

            // Start voice recognition
            startCallVoiceRecognition();

            showAlert('✅ Call started!', 'success');
        }

        // End Phone Call
        function endCall() {
            // Stop all audio and recognition
            stopAllAudioAndRecognition();

            if (callDurationInterval) {
                clearInterval(callDurationInterval);
                callDurationInterval = null;
            }

            if (callRecognition) {
                try { callRecognition.stop(); } catch (e) {}
                callRecognition = null;
            }

            document.getElementById('callInterface').style.display = 'none';
            isInCall = false;
            isCallMuted = false;

            document.getElementById('callMuteBtn').classList.remove('muted');

            showAlert('📞 Call ended', 'info');
        }

        // Video Call Voice Recognition
        function startVideoVoiceRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                showAlert('❌ Voice recognition not supported in this browser', 'error');
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            videoRecognition = new SpeechRecognition();
            videoRecognition.lang = 'en-US';
            videoRecognition.continuous = false; // Changed to false - we'll manually restart
            videoRecognition.interimResults = false;
            videoRecognition.maxAlternatives = 1;

            videoRecognition.onstart = () => {
                console.log('Video call - listening started');
                document.getElementById('listeningIndicator').style.display = 'flex';
            };

            videoRecognition.onresult = async (event) => {
                const transcript = event.results[0][0].transcript;
                console.log('Video call - heard:', transcript);
                document.getElementById('listeningIndicator').style.display = 'none';

                // Add to transcript
                const transcriptDiv = document.getElementById('videoTranscript');
                transcriptDiv.innerHTML += `
                    <div class="transcript-entry transcript-user">
                        <strong>You:</strong> ${transcript}
                    </div>
                `;
                transcriptDiv.scrollTop = transcriptDiv.scrollHeight;

                // Get AI response (this will restart recognition when done)
                await processVideoCallAI(transcript);
            };

            videoRecognition.onerror = (event) => {
                console.error('Video recognition error:', event.error);
                document.getElementById('listeningIndicator').style.display = 'none';

                if (event.error === 'no-speech') {
                    // Just restart if no speech detected
                    if (isInVideoCall && !isVideoMuted) {
                        setTimeout(() => {
                            try { videoRecognition.start(); } catch (e) {}
                        }, 500);
                    }
                } else if (event.error !== 'aborted') {
                    // For other errors, show message and try to restart
                    console.log('Restarting video recognition after error...');
                    if (isInVideoCall && !isVideoMuted) {
                        setTimeout(() => {
                            try { videoRecognition.start(); } catch (e) {}
                        }, 1000);
                    }
                }
            };

            videoRecognition.onend = () => {
                console.log('Video recognition ended');
                document.getElementById('listeningIndicator').style.display = 'none';

                // Auto-restart if still in call and not muted
                if (isInVideoCall && !isVideoMuted) {
                    setTimeout(() => {
                        try {
                            videoRecognition.start();
                            console.log('Video recognition restarted');
                        } catch (e) {
                            console.error('Failed to restart video recognition:', e);
                        }
                    }, 500);
                }
            };

            try {
                videoRecognition.start();
                console.log('Video recognition started');
            } catch (error) {
                console.error('Failed to start video recognition:', error);
                showAlert('❌ Failed to start voice recognition', 'error');
            }
        }

        // Phone Call Voice Recognition
        function startCallVoiceRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                showAlert('❌ Voice recognition not supported in this browser', 'error');
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            callRecognition = new SpeechRecognition();
            callRecognition.lang = 'en-US';
            callRecognition.continuous = false; // Changed to false - we'll manually restart
            callRecognition.interimResults = false;
            callRecognition.maxAlternatives = 1;

            callRecognition.onstart = () => {
                console.log('Phone call - listening started');
                document.getElementById('listeningIndicator').style.display = 'flex';
            };

            callRecognition.onresult = async (event) => {
                const transcript = event.results[0][0].transcript;
                console.log('Phone call - heard:', transcript);
                document.getElementById('listeningIndicator').style.display = 'none';

                // Add to transcript
                const transcriptDiv = document.getElementById('callTranscript');
                transcriptDiv.innerHTML += `
                    <div class="transcript-entry transcript-user">
                        <strong>You:</strong> ${transcript}
                    </div>
                `;
                transcriptDiv.scrollTop = transcriptDiv.scrollHeight;

                // Get AI response (this will restart recognition when done)
                await processCallAI(transcript);
            };

            callRecognition.onerror = (event) => {
                console.error('Call recognition error:', event.error);
                document.getElementById('listeningIndicator').style.display = 'none';

                if (event.error === 'no-speech') {
                    // Just restart if no speech detected
                    if (isInCall && !isCallMuted) {
                        setTimeout(() => {
                            try { callRecognition.start(); } catch (e) {}
                        }, 500);
                    }
                } else if (event.error !== 'aborted') {
                    // For other errors, try to restart
                    console.log('Restarting call recognition after error...');
                    if (isInCall && !isCallMuted) {
                        setTimeout(() => {
                            try { callRecognition.start(); } catch (e) {}
                        }, 1000);
                    }
                }
            };

            callRecognition.onend = () => {
                console.log('Call recognition ended');
                document.getElementById('listeningIndicator').style.display = 'none';

                // Auto-restart if still in call and not muted
                if (isInCall && !isCallMuted) {
                    setTimeout(() => {
                        try {
                            callRecognition.start();
                            console.log('Call recognition restarted');
                        } catch (e) {
                            console.error('Failed to restart call recognition:', e);
                        }
                    }, 500);
                }
            };

            try {
                callRecognition.start();
                console.log('Call recognition started');
            } catch (error) {
                console.error('Failed to start call recognition:', error);
                showAlert('❌ Failed to start voice recognition', 'error');
            }
        }

        // Process Video Call AI Response
        async function processVideoCallAI(userMessage) {
            try {
                document.getElementById('speakingIndicator').style.display = 'flex';

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${geminiApiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: `You are a health assistant in a video call. Current medications: ${medications.map(m => m.name).join(', ') || 'None'}.

IMPORTANT:
- Keep answers VERY SHORT (1-2 sentences max)
- Use simple, clear language
- Be direct and helpful
- No long explanations

Question: ${userMessage}` }]
                        }]
                    })
                });

                const data = await response.json();
                const aiResponse = data.candidates[0].content.parts[0].text;

                // Format response with HTML
                const formattedResponse = aiResponse
                    .replace(/\n/g, '<br>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/• /g, '<br>• ');

                // Add to transcript
                const transcriptDiv = document.getElementById('videoTranscript');
                transcriptDiv.innerHTML += `
                    <div class="transcript-entry transcript-ai">
                        <strong>AI:</strong> ${formattedResponse}
                    </div>
                `;
                transcriptDiv.scrollTop = transcriptDiv.scrollHeight;

                // Speak response
                speakText(aiResponse);

                setTimeout(() => {
                    document.getElementById('speakingIndicator').style.display = 'none';
                }, 2000);
            } catch (error) {
                console.error('Video call AI error:', error);
                document.getElementById('speakingIndicator').style.display = 'none';
            }
        }

        // Process Phone Call AI Response
        async function processCallAI(userMessage) {
            try {
                document.getElementById('speakingIndicator').style.display = 'flex';

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${geminiApiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: `You are a health assistant on a phone call. Current medications: ${medications.map(m => m.name).join(', ') || 'None'}.

IMPORTANT:
- Keep answers VERY SHORT (1-2 sentences max)
- Use simple, clear language
- Be direct and helpful
- No long explanations

Question: ${userMessage}` }]
                        }]
                    })
                });

                const data = await response.json();
                const aiResponse = data.candidates[0].content.parts[0].text;

                // Format response with HTML
                const formattedResponse = aiResponse
                    .replace(/\n/g, '<br>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/• /g, '<br>• ');

                // Add to transcript
                const transcriptDiv = document.getElementById('callTranscript');
                transcriptDiv.innerHTML += `
                    <div class="transcript-entry transcript-ai">
                        <strong>AI:</strong> ${formattedResponse}
                    </div>
                `;
                transcriptDiv.scrollTop = transcriptDiv.scrollHeight;

                // Speak response
                speakText(aiResponse);

                setTimeout(() => {
                    document.getElementById('speakingIndicator').style.display = 'none';
                }, 2000);
            } catch (error) {
                console.error('Call AI error:', error);
                document.getElementById('speakingIndicator').style.display = 'none';
            }
        }

        // Toggle Video Mute
        function toggleVideoMute() {
            isVideoMuted = !isVideoMuted;
            const btn = document.getElementById('videoMuteBtn');

            if (isVideoMuted) {
                btn.classList.add('muted');
                if (videoRecognition) {
                    try { videoRecognition.stop(); } catch (e) {}
                }
            } else {
                btn.classList.remove('muted');
                if (videoRecognition && isInVideoCall) {
                    try { videoRecognition.start(); } catch (e) {}
                }
            }
        }

        // Toggle Video Camera
        function toggleVideoCamera() {
            isVideoCameraOff = !isVideoCameraOff;
            const btn = document.getElementById('videoCameraBtn');

            if (videoStream) {
                videoStream.getVideoTracks().forEach(track => {
                    track.enabled = !isVideoCameraOff;
                });
            }

            if (isVideoCameraOff) {
                btn.classList.add('off');
            } else {
                btn.classList.remove('off');
            }
        }

        // Capture and Analyze Video Frame
        async function captureAndAnalyzeVideo() {
            const video = document.getElementById('userVideo');
            const canvas = document.getElementById('videoCaptureCanvas');

            if (!video || !canvas) return;

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);

            document.getElementById('videoAnalysisIndicator').style.display = 'flex';

            try {
                const imageData = canvas.toDataURL('image/jpeg', 0.8);
                const base64 = imageData.split(',')[1];

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${geminiApiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: 'Analyze this image for any health-related concerns, medications, or medical documents. Describe what you see.' },
                                { inline_data: { mime_type: 'image/jpeg', data: base64 } }
                            ]
                        }]
                    })
                });

                const data = await response.json();
                const analysis = data.candidates[0].content.parts[0].text;

                const transcriptDiv = document.getElementById('videoTranscript');
                transcriptDiv.innerHTML += `
                    <div class="transcript-entry transcript-ai">
                        <strong>AI Analysis:</strong> ${analysis}
                    </div>
                `;
                transcriptDiv.scrollTop = transcriptDiv.scrollHeight;

                speakText(analysis);
            } catch (error) {
                console.error('Video analysis error:', error);
            }

            document.getElementById('videoAnalysisIndicator').style.display = 'none';
        }

        // Toggle Call Mute
        function toggleCallMute() {
            isCallMuted = !isCallMuted;
            const btn = document.getElementById('callMuteBtn');

            if (isCallMuted) {
                btn.classList.add('muted');
                if (callRecognition) {
                    try { callRecognition.stop(); } catch (e) {}
                }
            } else {
                btn.classList.remove('muted');
                if (callRecognition && isInCall) {
                    try { callRecognition.start(); } catch (e) {}
                }
            }
        }

        // Copy Video Transcript
        function copyVideoTranscript() {
            const transcriptElement = document.getElementById('videoTranscript');
            if (!transcriptElement) {
                showAlert('❌ Transcript not found', 'error');
                return;
            }

            const transcript = transcriptElement.innerText || transcriptElement.textContent;

            if (!transcript || transcript.trim().length === 0) {
                showAlert('⚠️ No transcript to copy', 'warning');
                return;
            }

            if (!navigator.clipboard) {
                showAlert('❌ Clipboard not supported in this browser', 'error');
                return;
            }

            navigator.clipboard.writeText(transcript).then(() => {
                showAlert('✅ Video transcript copied!', 'success');
            }).catch((error) => {
                console.error('Copy error:', error);
                showAlert('❌ Failed to copy transcript', 'error');
            });
        }

        // Copy Call Transcript
        function copyCallTranscript() {
            const transcriptElement = document.getElementById('callTranscript');
            if (!transcriptElement) {
                showAlert('❌ Transcript not found', 'error');
                return;
            }

            const transcript = transcriptElement.innerText || transcriptElement.textContent;

            if (!transcript || transcript.trim().length === 0) {
                showAlert('⚠️ No transcript to copy', 'warning');
                return;
            }

            if (!navigator.clipboard) {
                showAlert('❌ Clipboard not supported in this browser', 'error');
                return;
            }

            navigator.clipboard.writeText(transcript).then(() => {
                showAlert('✅ Call transcript copied!', 'success');
            }).catch((error) => {
                console.error('Copy error:', error);
                showAlert('❌ Failed to copy transcript', 'error');
            });
        }

        // Emergency call (always dials emergency services)
        function emergencyCall() {
            const confirmed = confirm('Call Emergency Services (10177)?\n\nThis will dial South African emergency services.');
            if (confirmed) {
                window.location.href = 'tel:10177';
            }
        }

        // ========== NEW FEATURES FUNCTIONS ==========

        // Global variables for new features
        let appointments = [];
        let journalEntries = [];
        let medicationHistory = [];
        let currentLanguage = 'en';
        let isDarkMode = false;

        // Load data on init
        function loadNewFeaturesData() {
            const savedAppointments = localStorage.getItem('appointments');
            const savedJournal = localStorage.getItem('journalEntries');
            const savedHistory = localStorage.getItem('medicationHistory');
            const savedLanguage = localStorage.getItem('appLanguage');
            const savedDarkMode = localStorage.getItem('darkMode');

            if (savedAppointments) appointments = JSON.parse(savedAppointments);
            if (savedJournal) journalEntries = JSON.parse(savedJournal);
            if (savedHistory) medicationHistory = JSON.parse(savedHistory);
            if (savedLanguage) {
                currentLanguage = savedLanguage;
                document.getElementById('appLanguage').value = savedLanguage;
            }
            if (savedDarkMode === 'true') {
                isDarkMode = true;
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeToggle').checked = true;
            }
        }

        // Initialize new features on load
        document.addEventListener('DOMContentLoaded', function() {
            loadNewFeaturesData();
            updateAppointmentsList();
            updateJournalEntries();
            updateMedicationHistory();
            checkRefillAlerts();
            checkAppointmentReminders();
        });

        // Pill Image Preview
        function previewMedImage(input) {
            const preview = document.getElementById('medImagePreview');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" style="max-width: 200px; border-radius: var(--radius); border: 2px solid var(--gray-300);">`;
                };
                reader.readAsDataURL(input.files[0]);
            } else {
                preview.innerHTML = '';
            }
        }

        // Update addMedication to include new fields
        const originalAddMedication = addMedication;
        async function addMedication(event) {
            event.preventDefault();

            try {
                const imageInput = document.getElementById('medImage');
                let imageData = null;
                if (imageInput.files && imageInput.files[0]) {
                    imageData = await fileToBase64(imageInput.files[0]);
                }

                const medication = {
                    id: Date.now(),
                    name: sanitizeInput(document.getElementById('medName').value),
                    dosage: sanitizeInput(document.getElementById('medDosage').value),
                    time: document.getElementById('medTime').value,
                    frequency: document.getElementById('medFrequency').value,
                    image: imageData,
                    stock: parseInt(document.getElementById('medStock').value) || 0,
                    refillAlert: parseInt(document.getElementById('medRefillAlert').value) || 0,
                    taken: false,
                    createdAt: new Date().toISOString()
                };

                validateMedicationData(medication);

                medications.push(medication);
                saveMedications();

                try {
                    await esp32Request('/api/medications', 'POST', medication);
                } catch (error) {
                    console.warn('Failed to sync to ESP32, will retry later');
                }

                updateDashboard();
                closeModal('addMedModal');
                showAlert('Medication added successfully!', 'success');
                event.target.reset();
                document.getElementById('medImagePreview').innerHTML = '';

                checkRefillAlerts();

            } catch (error) {
                showAlert(error.message, 'error');
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Refill Alerts
        function checkRefillAlerts() {
            medications.forEach(med => {
                if (med.stock > 0 && med.refillAlert > 0 && med.stock <= med.refillAlert) {
                    showAlert(`⚠️ Low stock: ${med.name} (${med.stock} pills left)`, 'warning');
                }
            });
        }

        // Medication History
        function updateMedicationHistory() {
            const filter = document.getElementById('historyFilter')?.value || 'all';
            const dateFilter = document.getElementById('historyDate')?.value;
            const container = document.getElementById('medicationHistory');

            if (!container) return;

            let history = medications.filter(m => m.takenAt);

            if (filter === 'taken') {
                history = history.filter(m => m.taken);
            } else if (filter === 'missed') {
                history = history.filter(m => !m.taken && new Date(m.time) < new Date());
            }

            if (dateFilter) {
                const filterDate = new Date(dateFilter).toDateString();
                history = history.filter(m => new Date(m.takenAt).toDateString() === filterDate);
            }

            history.sort((a, b) => new Date(b.takenAt) - new Date(a.takenAt));

            container.innerHTML = history.length === 0
                ? '<p style="text-align: center; color: var(--gray-500); padding: 40px;">No history found</p>'
                : history.map(med => `
                    <div class="medication-item">
                        <div class="medication-info">
                            ${med.image ? `<img src="${med.image}" style="width: 50px; height: 50px; border-radius: var(--radius-sm); object-fit: cover; margin-right: 12px;">` : ''}
                            <div>
                                <div class="medication-name">${med.name}</div>
                                <div class="medication-time">Taken: ${new Date(med.takenAt).toLocaleString()}</div>
                                <div class="medication-dosage">Dosage: ${med.dosage}</div>
                            </div>
                        </div>
                        <div class="status-indicator ${med.taken ? 'status-taken' : 'status-missed'}"></div>
                    </div>
                `).join('');
        }

        // Export History
        function exportHistory() {
            const history = medications.filter(m => m.takenAt);
            const csv = [
                'Medication,Dosage,Time Scheduled,Time Taken,Status',
                ...history.map(m => `${m.name},${m.dosage},${m.time},${new Date(m.takenAt).toLocaleString()},${m.taken ? 'Taken' : 'Missed'}`)
            ].join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `medication-history-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            showAlert('✅ History exported!', 'success');
        }

        // Appointments
        function addAppointment(event) {
            event.preventDefault();

            const appointment = {
                id: Date.now(),
                doctor: sanitizeInput(document.getElementById('appointmentDoctor').value),
                type: document.getElementById('appointmentType').value,
                dateTime: document.getElementById('appointmentDateTime').value,
                location: sanitizeInput(document.getElementById('appointmentLocation').value),
                notes: sanitizeInput(document.getElementById('appointmentNotes').value),
                createdAt: new Date().toISOString()
            };

            appointments.push(appointment);
            localStorage.setItem('appointments', JSON.stringify(appointments));

            updateAppointmentsList();
            closeModal('addAppointmentModal');
            showAlert('✅ Appointment added!', 'success');
            event.target.reset();
        }

        function updateAppointmentsList() {
            const container = document.getElementById('appointmentsList');
            if (!container) return;

            const sortedAppointments = appointments.sort((a, b) => new Date(a.dateTime) - new Date(b.dateTime));
            const now = new Date();

            container.innerHTML = appointments.length === 0
                ? '<p style="text-align: center; color: var(--gray-500); padding: 40px;">No appointments scheduled</p>'
                : sortedAppointments.map(apt => {
                    const aptDate = new Date(apt.dateTime);
                    const isPast = aptDate < now;
                    return `
                        <div class="medication-item" style="${isPast ? 'opacity: 0.6;' : ''}">
                            <div class="medication-info">
                                <div class="medication-name">${apt.doctor}</div>
                                <div class="medication-time">📅 ${aptDate.toLocaleString()}</div>
                                <div class="medication-dosage">Type: ${apt.type} ${apt.location ? `| 📍 ${apt.location}` : ''}</div>
                                ${apt.notes ? `<div style="font-size: 12px; color: var(--gray-600); margin-top: 4px;">${apt.notes}</div>` : ''}
                            </div>
                            <button class="confirm-btn" onclick="deleteAppointment(${apt.id})" style="background: var(--danger);">Delete</button>
                        </div>
                    `;
                }).join('');
        }

        function deleteAppointment(id) {
            if (!confirm('Delete this appointment?')) return;
            appointments = appointments.filter(a => a.id !== id);
            localStorage.setItem('appointments', JSON.stringify(appointments));
            updateAppointmentsList();
            showAlert('Appointment deleted', 'info');
        }

        function checkAppointmentReminders() {
            const now = new Date();
            appointments.forEach(apt => {
                const aptDate = new Date(apt.dateTime);
                const hoursDiff = (aptDate - now) / (1000 * 60 * 60);
                if (hoursDiff > 0 && hoursDiff < 24) {
                    showAlert(`📅 Reminder: Appointment with ${apt.doctor} in ${Math.round(hoursDiff)} hours`, 'info');
                }
            });
        }

        // Health Journal
        function addJournalEntry(event) {
            event.preventDefault();

            const entry = {
                id: Date.now(),
                date: document.getElementById('journalDate').value,
                mood: document.getElementById('journalMood').value,
                symptoms: sanitizeInput(document.getElementById('journalSymptoms').value),
                notes: sanitizeInput(document.getElementById('journalNotes').value),
                createdAt: new Date().toISOString()
            };

            journalEntries.push(entry);
            localStorage.setItem('journalEntries', JSON.stringify(journalEntries));

            updateJournalEntries();
            closeModal('addJournalModal');
            showAlert('✅ Journal entry saved!', 'success');
            event.target.reset();
        }

        function updateJournalEntries() {
            const container = document.getElementById('journalEntries');
            if (!container) return;

            const sortedEntries = journalEntries.sort((a, b) => new Date(b.date) - new Date(a.date));

            container.innerHTML = journalEntries.length === 0
                ? '<p style="text-align: center; color: var(--gray-500); padding: 40px;">No journal entries yet</p>'
                : sortedEntries.map(entry => `
                    <div class="medication-item" style="flex-direction: column; align-items: stretch;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div>
                                <div class="medication-name">${new Date(entry.date).toLocaleDateString()}</div>
                                <div class="medication-time">Mood: ${getMoodEmoji(entry.mood)}</div>
                                ${entry.symptoms ? `<div class="medication-dosage">Symptoms: ${entry.symptoms}</div>` : ''}
                            </div>
                            <button class="confirm-btn" onclick="deleteJournalEntry(${entry.id})" style="background: var(--danger); padding: 8px 12px; font-size: 12px;">Delete</button>
                        </div>
                        <div style="background: var(--gray-50); padding: 12px; border-radius: var(--radius-sm); font-size: 14px; line-height: 1.6;">
                            ${entry.notes}
                        </div>
                    </div>
                `).join('');
        }

        function getMoodEmoji(mood) {
            const moods = {
                'great': '😊 Great',
                'good': '🙂 Good',
                'okay': '😐 Okay',
                'bad': '😞 Not Good',
                'terrible': '😢 Terrible'
            };
            return moods[mood] || mood;
        }

        function deleteJournalEntry(id) {
            if (!confirm('Delete this journal entry?')) return;
            journalEntries = journalEntries.filter(e => e.id !== id);
            localStorage.setItem('journalEntries', JSON.stringify(journalEntries));
            updateJournalEntries();
            showAlert('Journal entry deleted', 'info');
        }

        // Family Portal
        function generateFamilyLink() {
            const patientId = Date.now().toString(36);
            const shareToken = btoa(patientId + '-' + Date.now());
            const shareUrl = `${window.location.origin}${window.location.pathname}?family=${shareToken}`;

            const linkContainer = document.getElementById('familyShareLink');
            linkContainer.innerHTML = `
                <div style="background: var(--gray-50); padding: 16px; border-radius: var(--radius); border: 2px dashed var(--primary);">
                    <p style="font-weight: 600; margin-bottom: 8px; color: var(--primary);">🔗 Shareable Link Generated!</p>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="text" value="${shareUrl}" id="familyShareUrl" readonly class="form-input" style="flex: 1; font-size: 12px;">
                        <button onclick="copyFamilyLink()" class="action-btn" style="flex: none;">Copy</button>
                    </div>
                    <p style="font-size: 12px; color: var(--gray-600); margin-top: 8px;">Share this link with family members to let them view your medication status.</p>
                </div>
            `;

            localStorage.setItem('familyShareToken', shareToken);
            showAlert('✅ Share link generated!', 'success');
        }

        function copyFamilyLink() {
            const input = document.getElementById('familyShareUrl');
            input.select();
            navigator.clipboard.writeText(input.value).then(() => {
                showAlert('✅ Link copied to clipboard!', 'success');
            }).catch(() => {
                showAlert('❌ Failed to copy link', 'error');
            });
        }

        // Dark Mode
        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
            localStorage.setItem('darkMode', isDarkMode);
        }

        // Language Support
        const translations = {
            en: { title: 'MediCare Assistant', medications: 'Medications', settings: 'Settings' },
            es: { title: 'Asistente MediCare', medications: 'Medicamentos', settings: 'Configuración' },
            fr: { title: 'Assistant MediCare', medications: 'Médicaments', settings: 'Paramètres' },
            de: { title: 'MediCare Assistent', medications: 'Medikamente', settings: 'Einstellungen' },
            pt: { title: 'Assistente MediCare', medications: 'Medicamentos', settings: 'Configurações' },
            zh: { title: 'MediCare 助手', medications: '药物', settings: '设置' }
        };

        function changeLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('appLanguage', lang);
            // Basic translation - can be expanded
            showAlert(`Language changed to ${lang}. Full translation coming soon!`, 'info');
        }

        // Custom Notification Sounds
        function playReminderSound() {
            const soundType = localStorage.getItem('notificationSound') || 'beep';
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            switch(soundType) {
                case 'chime':
                    oscillator.frequency.value = 800;
                    oscillator.type = 'sine';
                    break;
                case 'bell':
                    oscillator.frequency.value = 1000;
                    oscillator.type = 'triangle';
                    break;
                case 'gentle':
                    oscillator.frequency.value = 440;
                    oscillator.type = 'sine';
                    break;
                default: // beep
                    oscillator.frequency.value = 800;
                    oscillator.type = 'square';
            }

            const volume = localStorage.getItem('reminderVolume') || 80;
            gainNode.gain.value = volume / 100 * 0.3;

            oscillator.start();
            oscillator.stop(audioContext.currentTime + 0.5);
        }

        // Update saveSettings to include new settings
        const originalSaveSettings = saveSettings;
        async function saveSettings() {
            try {
                const apiKey = sanitizeInput(document.getElementById('apiKey').value);
                const patientName = sanitizeInput(document.getElementById('patientName').value);
                const emergencyContact = sanitizeInput(document.getElementById('emergencyContact').value);
                const esp32Enable = document.getElementById('esp32Enable').checked;
                const esp32Url = sanitizeInput(document.getElementById('esp32Url').value);
                const volume = document.getElementById('reminderVolume').value;
                const language = document.getElementById('appLanguage').value;
                const notificationSound = document.getElementById('notificationSound').value;

                if (apiKey) {
                    geminiApiKey = apiKey;
                    localStorage.setItem('geminiApiKey', apiKey);
                }
                if (patientName) localStorage.setItem('patientName', patientName);
                if (emergencyContact) localStorage.setItem('emergencyContact', emergencyContact);

                esp32Enabled = esp32Enable;
                localStorage.setItem('esp32Enabled', esp32Enable);

                if (esp32Enable && esp32Url) {
                    if (!esp32Url.startsWith('http://') && !esp32Url.startsWith('https://')) {
                        throw new Error('ESP32 URL must start with http:// or https://');
                    }
                    esp32BaseUrl = esp32Url;
                    localStorage.setItem('esp32BaseUrl', esp32Url);
                    reconnectAttempts = 0;
                    await connectToESP32();
                    initWebSocket();
                } else {
                    esp32BaseUrl = '';
                    esp32Connected = false;
                    document.getElementById('deviceStatus').textContent = 'Standalone';
                    document.getElementById('deviceStatus').style.color = 'var(--gray-500)';
                }

                localStorage.setItem('reminderVolume', volume);
                localStorage.setItem('appLanguage', language);
                localStorage.setItem('notificationSound', notificationSound);

                closeModal('settingsModal');
                showAlert('✅ Settings saved successfully!', 'success');
            } catch (error) {
                showAlert(error.message, 'error');
            }
        }

        // Update tab switching for new tabs
        const originalSwitchTab = switchTab;
        function switchTab(tabName) {
            if (tabName !== 'assistant') {
                stopAllAudioAndRecognition();
            }

            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));

            document.getElementById(tabName).classList.add('active');

            const buttons = document.querySelectorAll('.tab-btn');
            buttons.forEach(btn => {
                if (btn.textContent.toLowerCase().includes(tabName.toLowerCase()) ||
                    btn.getAttribute('onclick').includes(tabName)) {
                    btn.classList.add('active');
                }
            });

            // Update content when switching to new tabs
            if (tabName === 'medications') updateAllMedications();
            if (tabName === 'schedule') updateWeeklySchedule();
            if (tabName === 'analytics') updateAnalytics();
            if (tabName === 'history') updateMedicationHistory();
            if (tabName === 'appointments') updateAppointmentsList();
            if (tabName === 'journal') updateJournalEntries();
            if (tabName === 'hardware') refreshHardwareStatus();
        }

        // ========== HARDWARE TESTING FUNCTIONS ==========

        // Hardware status refresh
        function refreshHardwareStatus() {
            if (!esp32Enabled || !esp32BaseUrl) {
                showAlert('⚠️ ESP32 not configured. Enable in Settings.', 'warning');
                return;
            }

            showAlert('🔄 Refreshing hardware status...', 'info');

            // Simulate hardware status update (replace with actual ESP32 API calls)
            setTimeout(() => {
                document.getElementById('wifiStrength').textContent = '-' + (40 + Math.random() * 15).toFixed(0) + ' dBm';
                document.getElementById('potValue').textContent = Math.floor(Math.random() * 4096);
                document.getElementById('buzzerVolume').textContent = localStorage.getItem('reminderVolume') || '80' + '%';

                showAlert('✅ Hardware status updated', 'success');
            }, 500);
        }

        // LED Testing Functions
        function testAllLEDs() {
            showAlert('💡 Testing all LEDs...', 'info');
            const leds = ['red', 'green', 'blue'];
            let index = 0;

            const interval = setInterval(() => {
                if (index > 0) {
                    document.getElementById(`led${leds[index-1].charAt(0).toUpperCase() + leds[index-1].slice(1)}`).classList.remove('active');
                }
                if (index < leds.length) {
                    document.getElementById(`led${leds[index].charAt(0).toUpperCase() + leds[index].slice(1)}`).classList.add('active');
                    index++;
                } else {
                    clearInterval(interval);
                    document.getElementById(`led${leds[leds.length-1].charAt(0).toUpperCase() + leds[leds.length-1].slice(1)}`).classList.remove('active');
                    showAlert('✅ LED test completed', 'success');
                }
            }, 500);
        }

        function toggleLED(color) {
            showAlert(`Toggling ${color} LED...`, 'info');
            const ledElement = document.getElementById(`led${color.charAt(0).toUpperCase() + color.slice(1)}`);
            ledElement.classList.toggle('off');

            // Simulate ESP32 API call
            if (esp32Enabled && esp32BaseUrl) {
                esp32Request(`/api/led/${color}/toggle`, 'POST').catch(err => console.error(err));
            }
        }

        function cycleAllLEDs() {
            showAlert('🔄 Cycling all LEDs...', 'info');
            testAllLEDs();
        }

        // Buzzer Testing Functions
        function testBuzzer() {
            playTone('short');
        }

        function playTone(type) {
            showAlert(`🔊 Playing ${type} tone...`, 'info');
            const duration = type === 'short' ? 200 : type === 'long' ? 1000 : 500;

            // Play tone using Web Audio API
            playReminderSound();

            // Simulate ESP32 API call
            if (esp32Enabled && esp32BaseUrl) {
                esp32Request(`/api/buzzer/play`, 'POST', { type, duration }).catch(err => console.error(err));
            }
        }

        function stopBuzzer() {
            showAlert('⏹️ Buzzer stopped', 'info');
            if (esp32Enabled && esp32BaseUrl) {
                esp32Request(`/api/buzzer/stop`, 'POST').catch(err => console.error(err));
            }
        }

        function updateTestVolume(value) {
            document.getElementById('testVolume').textContent = value + '%';
        }

        // LCD Testing Functions
        function testLCD() {
            displayTestPattern();
        }

        function displayTestPattern() {
            showAlert('💻 Displaying test pattern...', 'info');

            if (esp32Enabled && esp32BaseUrl) {
                esp32Request('/api/lcd/test', 'POST', {
                    pattern: 'test'
                }).then(() => {
                    showAlert('✅ Test pattern displayed', 'success');
                }).catch(err => {
                    console.error(err);
                    showAlert('❌ Failed to display test pattern', 'error');
                });
            } else {
                showAlert('📟 Test Pattern:\n████████████████████\n█ ESP32 TEST MODE █\n█ 20x4 LCD DISPLAY █\n████████████████████', 'info');
            }
        }

        function displayCustomText() {
            const text = document.getElementById('lcdCustomText').value;
            if (!text) {
                showAlert('⚠️ Please enter custom text', 'warning');
                return;
            }

            showAlert('💻 Displaying custom text...', 'info');

            if (esp32Enabled && esp32BaseUrl) {
                esp32Request('/api/lcd/custom', 'POST', {
                    text: text
                }).then(() => {
                    showAlert('✅ Custom text displayed', 'success');
                }).catch(err => {
                    console.error(err);
                    showAlert('❌ Failed to display text', 'error');
                });
            } else {
                showAlert(`📟 Displayed: "${text}"`, 'success');
            }
        }

        function clearLCD() {
            showAlert('💻 Clearing LCD...', 'info');

            if (esp32Enabled && esp32BaseUrl) {
                esp32Request('/api/lcd/clear', 'POST').then(() => {
                    showAlert('✅ LCD cleared', 'success');
                }).catch(err => console.error(err));
            } else {
                showAlert('✅ LCD cleared', 'success');
            }
        }

        function adjustLCDBacklight() {
            showAlert('💡 Adjusting LCD backlight...', 'info');

            if (esp32Enabled && esp32BaseUrl) {
                esp32Request('/api/lcd/backlight', 'POST', {
                    brightness: 255
                }).then(() => {
                    showAlert('✅ Backlight adjusted', 'success');
                }).catch(err => console.error(err));
            } else {
                showAlert('✅ Backlight set to maximum', 'success');
            }
        }

        // Button Testing Functions
        function testButtons() {
            openModal('hardwareTestModal');
            startButtonTest();
        }

        let buttonTestActive = false;
        function startButtonTest() {
            if (buttonTestActive) {
                showAlert('⚠️ Button test already running', 'warning');
                return;
            }

            buttonTestActive = true;
            showAlert('🎛️ Button test started. Press each button...', 'info');

            // Reset all button statuses
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`btn${i}Status`).textContent = '⚪ Waiting...';
            }

            // Simulate button test (in real implementation, ESP32 would report button presses)
            if (!esp32Enabled || !esp32BaseUrl) {
                setTimeout(() => {
                    for (let i = 1; i <= 4; i++) {
                        setTimeout(() => {
                            document.getElementById(`btn${i}Status`).textContent = '🟢 Pressed';
                        }, i * 500);
                    }
                    setTimeout(() => {
                        buttonTestActive = false;
                        showAlert('✅ Button test completed', 'success');
                    }, 2500);
                }, 500);
            }
        }

        // I2C Scanner
        function scanI2C() {
            openModal('hardwareTestModal');
            runI2CScan();
        }

        function runI2CScan() {
            showAlert('🔍 Scanning I2C bus...', 'info');
            const resultsDiv = document.getElementById('i2cResults');
            resultsDiv.textContent = 'Scanning...';

            if (esp32Enabled && esp32BaseUrl) {
                esp32Request('/api/i2c/scan', 'GET').then(response => {
                    resultsDiv.textContent = `I2C Scan Results:\n\nDevices found:\n${response.devices.join('\n') || 'No devices found'}`;
                    showAlert('✅ I2C scan completed', 'success');
                }).catch(err => {
                    resultsDiv.textContent = 'Error scanning I2C bus';
                    console.error(err);
                });
            } else {
                setTimeout(() => {
                    resultsDiv.textContent = `I2C Scan Results:\n\n📟 Device found at address: 0x27\n(20x4 LCD Display)\n\n✅ Scan complete - 1 device found`;
                    showAlert('✅ I2C scan completed', 'success');
                }, 1000);
            }
        }

        // Test All Components
        function testAllComponents() {
            showAlert('🧪 Testing all components...', 'info');

            testAllLEDs();
            setTimeout(() => testBuzzer(), 2000);
            setTimeout(() => testLCD(), 3000);
            setTimeout(() => scanI2C(), 4000);

            setTimeout(() => {
                showAlert('✅ All component tests completed!', 'success');
            }, 5000);
        }

        // Toggle diagram view
        function toggleDiagramView() {
            const diagram = document.getElementById('hardwareDiagram');
            if (diagram.style.display === 'none') {
                diagram.style.display = 'block';
                showAlert('📐 Diagram shown', 'info');
            } else {
                diagram.style.display = 'none';
                showAlert('📐 Diagram hidden', 'info');
            }
        }

        // Mobile Menu Toggle
        function toggleMobileMenu() {
            const navMenu = document.getElementById('navMenu');
            const hamburger = document.querySelector('.hamburger-menu');

            navMenu.classList.toggle('active');
            hamburger.classList.toggle('active');
        }

        // Close mobile menu when clicking outside
        document.addEventListener('click', function(event) {
            const navMenu = document.getElementById('navMenu');
            const hamburger = document.querySelector('.hamburger-menu');

            if (navMenu && hamburger) {
                const isClickInsideMenu = navMenu.contains(event.target);
                const isClickOnHamburger = hamburger.contains(event.target);

                if (!isClickInsideMenu && !isClickOnHamburger && navMenu.classList.contains('active')) {
                    navMenu.classList.remove('active');
                    hamburger.classList.remove('active');
                }
            }
        });

        // Close mobile menu when clicking on a menu item
        document.addEventListener('DOMContentLoaded', function() {
            const navButtons = document.querySelectorAll('.nav-menu button');
            navButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const navMenu = document.getElementById('navMenu');
                    const hamburger = document.querySelector('.hamburger-menu');

                    if (navMenu && hamburger && window.innerWidth <= 1024) {
                        navMenu.classList.remove('active');
                        hamburger.classList.remove('active');
                    }
                });
            });

            // Close button functionality in mobile menu
            const navMenu = document.getElementById('navMenu');
            if (navMenu) {
                navMenu.addEventListener('click', function(event) {
                    // Check if click is on the ::before pseudo-element (close button area)
                    const rect = this.getBoundingClientRect();
                    const x = event.clientX - rect.left;
                    const y = event.clientY - rect.top;

                    // Close button is at top right (20px from right, 20px from top, 40x40px)
                    if (x >= rect.width - 60 && x <= rect.width - 20 && y >= 20 && y <= 60) {
                        const hamburger = document.querySelector('.hamburger-menu');
                        this.classList.remove('active');
                        if (hamburger) hamburger.classList.remove('active');
                    }
                });
            }
        });
    </script>

    <!-- AI Video Call Interface -->
    <div class="video-call-interface" id="videoCallInterface">
        <div class="video-call-header">
            <div class="video-status" id="videoCallStatus">Connecting to AI Health Assistant...</div>
            <div class="video-duration" id="videoCallDuration">00:00</div>
        </div>
        <div class="video-call-content">
            <div class="video-main">
                <video id="userVideo" class="user-video" autoplay muted playsinline></video>
                <canvas id="videoCaptureCanvas" style="display: none;"></canvas>
                <div class="video-analysis-indicator" id="videoAnalysisIndicator">
                    <div class="analysis-pulse"></div>AI Analyzing...
                </div>
            </div>
            <div class="video-sidebar">
                <div class="ai-video-avatar" id="videoCallAvatar">🏥</div>
                <div class="video-controls">
                    <button class="video-control-btn" id="videoMuteBtn" onclick="toggleVideoMute()" title="Mute/Unmute">🎤</button>
                    <button class="video-control-btn" id="videoCameraBtn" onclick="toggleVideoCamera()" title="Camera On/Off">📹</button>
                    <button class="video-control-btn" onclick="captureAndAnalyzeVideo()" title="Capture & Analyze">📸</button>
                    <button class="video-control-btn" onclick="copyVideoTranscript()" title="Copy Transcript">📋</button>
                    <button class="video-control-btn video-end-btn" onclick="endVideoCall()" title="End Call">📞</button>
                </div>
                <div class="video-transcript" id="videoTranscript">
                    <div class="transcript-entry transcript-ai">
                        <strong>AI Health Assistant:</strong> Hi! I can see you. How can I help you today?
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Phone Call Interface -->
    <div class="call-interface" id="callInterface">
        <div class="call-content">
            <div class="call-avatar" id="callAvatar">🏥</div>
            <div class="call-status" id="callStatus">Connecting to AI Health Assistant...</div>
            <div class="call-duration" id="callDuration">00:00</div>
            <div class="call-controls">
                <button class="call-control-btn" id="callMuteBtn" onclick="toggleCallMute()" title="Mute/Unmute">🎤</button>
                <button class="call-control-btn" onclick="copyCallTranscript()" title="Copy Transcript">📋</button>
                <button class="call-control-btn end-call-btn" onclick="endCall()" title="End Call">📞</button>
            </div>
            <div class="call-transcript" id="callTranscript">
                <div class="transcript-entry transcript-ai">
                    <strong>AI Health Assistant:</strong> Hi! I'm here to help with your health questions. What can I assist you with?
                </div>
            </div>
        </div>
    </div>

    <!-- Listening/Speaking Indicators -->
    <div class="listening-indicator" id="listeningIndicator">
        <div class="listening-pulse"></div>
        Listening...
    </div>

    <div class="speaking-indicator" id="speakingIndicator">
        <div class="speaking-bars">
            <div class="speaking-bar"></div>
            <div class="speaking-bar"></div>
            <div class="speaking-bar"></div>
            <div class="speaking-bar"></div>
        </div>
        AI Speaking...
    </div>

    <!-- Floating Chatbot Button -->
    <div class="chatbot-float" onclick="openChatbot()" title="Chat with AI Assistant">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2C6.48 2 2 6.48 2 12c0 1.54.36 3 .97 4.29L2 22l5.71-.97C9 21.64 10.46 22 12 22c5.52 0 10-4.48 10-10S17.52 2 12 2zm0 18c-1.38 0-2.68-.31-3.86-.86l-.28-.14-2.86.49.49-2.86-.14-.28C4.31 14.68 4 13.38 4 12c0-4.41 3.59-8 8-8s8 3.59 8 8-3.59 8-8 8z"/>
            <circle cx="9" cy="12" r="1"/>
            <circle cx="12" cy="12" r="1"/>
            <circle cx="15" cy="12" r="1"/>
        </svg>
    </div>

    <!-- Chatbot Modal -->
    <div class="modal chatbot-modal" id="chatbotModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">🤖 AI Health Assistant</h3>
                <button class="close-modal" onclick="closeChatbot()">&times;</button>
            </div>
            <div class="chatbot-messages" id="chatbotMessages">
                <div style="padding: 12px; background: #ffffff; border: 1px solid var(--gray-300); border-radius: var(--radius); margin-bottom: 12px;">
                    <strong>AI Assistant:</strong> Hello! I'm your AI health assistant. I can help you with medication questions, health advice, and more. How can I assist you today?
                </div>
            </div>
            <div class="chatbot-input-area">
                <input type="text" id="chatbotInput" class="form-input" placeholder="Type your message..." onkeypress="handleChatbotKeyPress(event)" style="flex: 1;">
                <button class="action-btn-secondary" onclick="startChatbotVoice()" style="flex: none; padding: 12px 16px;" title="Voice Input">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                        <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                    </svg>
                </button>
                <button class="action-btn" onclick="sendChatbotMessage()" style="flex: none;">Send</button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-section">
                <h3 class="footer-title">🏥 MediCare Assistant</h3>
                <p class="footer-text">Your intelligent companion for medication management and elderly care.</p>
                <div class="footer-social">
                    <a href="#" class="social-link" title="Facebook">📘</a>
                    <a href="#" class="social-link" title="Twitter">🐦</a>
                    <a href="#" class="social-link" title="Instagram">📷</a>
                    <a href="#" class="social-link" title="LinkedIn">💼</a>
                </div>
            </div>

            <div class="footer-section">
                <h4 class="footer-subtitle">Quick Links</h4>
                <ul class="footer-links">
                    <li><a href="#" onclick="switchTab('dashboard'); return false;">Dashboard</a></li>
                    <li><a href="#" onclick="switchTab('medications'); return false;">Medications</a></li>
                    <li><a href="#" onclick="switchTab('appointments'); return false;">Appointments</a></li>
                    <li><a href="#" onclick="switchTab('journal'); return false;">Health Journal</a></li>
                </ul>
            </div>

            <div class="footer-section">
                <h4 class="footer-subtitle">Resources</h4>
                <ul class="footer-links">
                    <li><a href="#" onclick="openModal('aboutModal'); return false;">About Us</a></li>
                    <li><a href="#" onclick="openModal('contactModal'); return false;">Contact Support</a></li>
                    <li><a href="#" onclick="openModal('familyPortalModal'); return false;">Family Portal</a></li>
                    <li><a href="#" onclick="handleEmergency(); return false;">Emergency Help</a></li>
                </ul>
            </div>

            <div class="footer-section">
                <h4 class="footer-subtitle">Contact Info</h4>
                <ul class="footer-contact">
                    <li>📞 Emergency: 10177</li>
                    <li>📧 support@medicare.com</li>
                    <li>🏥 24/7 AI Assistant</li>
                    <li>🌍 Global Service</li>
                </ul>
            </div>
        </div>

        <div class="footer-bottom">
            <p>&copy; 2025 MediCare Assistant. All rights reserved.</p>
            <p>Developed with ❤️ for elderly care | <a href="#" onclick="openModal('aboutModal'); return false;">Privacy Policy</a> | <a href="#" onclick="openModal('contactModal'); return false;">Terms of Service</a></p>
        </div>
    </footer>
</body>
</html>